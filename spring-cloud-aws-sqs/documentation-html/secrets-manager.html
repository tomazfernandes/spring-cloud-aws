<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Secrets Manager Integration</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}

</style>
<script type="text/javascript">
function addBlockSwitches() {
	for (var primary of document.querySelectorAll('.primary')) {
		var switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		var title = primary.querySelector('.title')
		title.remove();
	}
	for (var secondary of document.querySelectorAll('.secondary')) {
		var primary = findPrimary(secondary);
		if (primary === null) {
			console.error("Found secondary block with no primary sibling");
		}
		else {
			var switchItem = createSwitchItem(secondary, primary.querySelector('.switch'));
			switchItem.content.classList.add("hidden");
			primary.append(switchItem.content);
			secondary.remove();
		}
	}
}

function createElementFromHtml(html) {
	var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.firstChild;
}

function createBlockSwitch(primary) {
    var blockSwitch = createElementFromHtml('<div class="switch"></div>');
    primary.prepend(blockSwitch)
	return blockSwitch;
}

function findPrimary(secondary) {
	var candidate = secondary.previousElementSibling;
	while (candidate != null && !candidate.classList.contains('primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	var blockName = block.querySelector('.title').textContent;
	var content = block.querySelectorAll('.content').item(0);
	var colist = nextSibling(block, '.colist');
	if (colist != null) {
		content.append(colist);
	}
	var item = createElementFromHtml('<div class="switch--item">' + blockName + '</div>');
	item.dataset.blockName = blockName;
	content.dataset.blockName = blockName;
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function nextSibling(element, selector) {
	var sibling = element.nextElementSibling;
	while (sibling) {
		if (sibling.matches(selector)) {
			return sibling;
		}
		sibling = sibling.nextElementSibling;
	}
}

function globalSwitch() {
	document.querySelectorAll(".switch--item").forEach(function(item) {
		var blockId = blockIdForSwitchItem(item);
		var handler = function(event) {
			selectedText = event.target.textContent;
			window.localStorage.setItem(blockId, selectedText);
			for (var switchItem of document.querySelectorAll(".switch--item")) {
				if (blockIdForSwitchItem(switchItem) === blockId && switchItem.textContent === selectedText) {
					select(switchItem);
				}
			}
		}
		item.addEventListener("click", handler);
		if (item.textContent === window.localStorage.getItem(blockId)) {
			select(item);
		}
	});
}

function select(selected) {
	for (var child of selected.parentNode.children) {
		child.classList.remove("selected");
	}
	selected.classList.add("selected");
	for (var child of selected.parentNode.parentNode.children) {
		if (child.classList.contains("content")) {
			if (selected.dataset.blockName === child.dataset.blockName) {
				child.classList.remove("hidden");
			}
			else {
				child.classList.add("hidden");
			}
		}
	}	
}

function blockIdForSwitchItem(item) {
	idComponents = []
	for (var switchItem of item.parentNode.querySelectorAll(".switch--item")) {
		idComponents.push(switchItem.textContent.toLowerCase());
	}
	return idComponents.sort().join("-")
}

window.onload = function() {
	addBlockSwitches();
	globalSwitch();
};

</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#spring-cloud-aws-secrets-manager">Secrets Manager Integration</a>
<ul class="sectlevel2">
<li><a href="#_loading_external_configuration">Loading External Configuration</a></li>
<li><a href="#_using_secretsmanagerclient">Using SecretsManagerClient</a></li>
<li><a href="#_customizing_secretsmanagerclient">Customizing SecretsManagerClient</a></li>
<li><a href="#_configuration">Configuration</a></li>
<li><a href="#_iam_permissions">IAM Permissions</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="spring-cloud-aws-secrets-manager"><a class="link" href="#spring-cloud-aws-secrets-manager">Secrets Manager Integration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://aws.amazon.com/secrets-manager/">Secrets Manager</a> helps to protect secrets needed to access your applications, services, and IT resources. The service enables you to easily rotate, manage, and retrieve database credentials, API keys, and other secrets throughout their lifecycle.</p>
</div>
<div class="paragraph">
<p>Spring Cloud AWS adds support for loading configuration properties from Secrets Manager through Spring Boot <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config-files-importing">config import feature</a>.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="index.html#bill-of-materials">Spring Cloud AWS BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
	&lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
	&lt;artifactId&gt;spring-cloud-aws-starter-secrets-manager&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_loading_external_configuration"><a class="link" href="#_loading_external_configuration">Loading External Configuration</a></h3>
<div class="paragraph">
<p>To fetch secrets from Secrets Manager and add them to Spring&#8217;s environment properties, add <code>spring.config.import</code> property to <code>application.properties</code>:</p>
</div>
<div class="paragraph">
<p>For example, assuming that the secret name in Secrets Manager is <code>/secrets/database-secrets</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=aws-secretsmanager:/secrets/database-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a secret with given name does not exist in Secrets Manager, application will fail to start. If secret value is not required for the application, and it should continue to startup even when secret is missing, add <code>optional</code> before prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=optional:aws-secretsmanager:/secrets/database-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>To load multiple secrets, separate their names with <code>;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=aws-secretsmanager:/secrets/database-secrets;/secrets/webclient-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>If some secrets are required, and other ones are optional, list them as separate entries in <code>spring.config.import</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import[0]=optional:aws-secretsmanager=/secrets/required-secret
spring.config.import[1]=aws-secretsmanager=/secrets/optional-secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fetched secrets can be referenced with <code>@Value</code>, bound to <code>@ConfigurationProperties</code> classes, or referenced in <code>application.properties</code> file.</p>
</div>
<div class="sect3">
<h4 id="_using_key_value_json_secrets"><a class="link" href="#_using_key_value_json_secrets">Using Key-Value (JSON) Secrets</a></h4>
<div class="paragraph">
<p>Secrets resolved with <code>spring.config.import</code> can be also referenced in <code>application.properties</code>.
When a content of <code>SecretString</code> in a JSON, all top level JSON keys are added as properties to Spring Environment.</p>
</div>
<div class="paragraph">
<p>For example, with a file <code>mycreds.json</code> containing following JSON structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
      "username": "saanvi",
      "password": "EXAMPLE-PASSWORD"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secret is created with a command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ aws secretsmanager create-secret --name /secrets/database-secrets --secret-string file://mycreds.json</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>spring.config.import</code> entry is added to <code>application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=aws-secretsmanager:/secrets/database-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secret values can be referenced by JSON key names:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value("${username}"
private String username;

@Value("${password}"
private String password;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_plain_text_secrets"><a class="link" href="#_using_plain_text_secrets">Using plain text secrets</a></h4>
<div class="paragraph">
<p>If a <code>SecretString</code> is a plain text, use secret name to retrieve its value.
For example, we will JDBC saved as plain text secret type with name <code>/secrets/my-certificate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ aws secretsmanager create-secret --name /secrets/prod/jdbc-url --secret-string jdbc:url</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>spring.config.import</code> entry is added to <code>application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=aws-secretsmanager:/secrets/prod/jdbc-url</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secret value can be retrieved by referencing secret name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.datasource.url=${jdbc-url}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_secretsmanagerclient"><a class="link" href="#_using_secretsmanagerclient">Using SecretsManagerClient</a></h3>
<div class="paragraph">
<p>The starter automatically configures and registers a <code>SecretsManagerClient</code> bean in the Spring application context. The <code>SecretsManagerClient</code> bean can be used to create or retrieve secrets imperatively.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import org.springframework.stereotype.Component;
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClient;
import software.amazon.awssdk.services.secretsmanager.model.CreateSecretRequest;
...
@Autowired
private SecretsManagerClient secretsManagerClient;
...
secretsManagerClient.createSecret(CreateSecretRequest.builder().name(name).secretString(secret).build());</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_customizing_secretsmanagerclient"><a class="link" href="#_customizing_secretsmanagerclient">Customizing SecretsManagerClient</a></h3>
<div class="paragraph">
<p>To use custom <code>SecretsManagerClient</code> in <code>spring.config.import</code>, provide an implementation of <code>BootstrapRegistryInitializer</code>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.app;

import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;
import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClient;

import org.springframework.boot.BootstrapRegistry;
import org.springframework.boot.BootstrapRegistryInitializer;

public class SecretsManagerBootstrapConfiguration implements BootstrapRegistryInitializer {

    @Override
    public void initialize(BootstrapRegistry registry) {
        registry.register(SecretsManagerClient.class, context -&gt; {
            AwsCredentialsProvider awsCredentialsProvider = StaticCredentialsProvider.create(AwsBasicCredentials.create("yourAccessKey", "yourSecretKey"));
            return SecretsManagerClient.builder().credentialsProvider(awsCredentialsProvider).region(Region.EU_WEST_2).build();
        });
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this class must be listed under <code>org.springframework.boot.BootstrapRegistryInitializer</code> key in <code>META-INF/spring.factories</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">org.springframework.boot.BootstrapRegistryInitializer=com.app.SecretsManagerBootstrapConfiguration</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use autoconfigured <code>SecretsManagerClient</code> but change underlying SDKClient or ClientOverrideConfiguration you will need to register bean of type <code>AwsClientConfigurerSecretsManager</code>:
Autoconfiguration will configure <code>SecretsManagerClient</code> Bean with provided values after that, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.app;

import io.awspring.cloud.autoconfigure.config.secretsmanager.AwsSecretsManagerClientCustomizer;
import java.time.Duration;
import org.springframework.boot.BootstrapRegistry;
import org.springframework.boot.BootstrapRegistryInitializer;
import software.amazon.awssdk.core.client.config.ClientOverrideConfiguration;
import software.amazon.awssdk.http.SdkHttpClient;
import software.amazon.awssdk.http.apache.ApacheHttpClient;
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClientBuilder;

class SecretsManagerBootstrapConfiguration implements BootstrapRegistryInitializer {

	@Override
	public void initialize(BootstrapRegistry registry) {
		registry.register(AwsSecretsManagerClientCustomizer.class,
            context -&gt; new AwsSecretsManagerClientCustomizer() {

                @Override
                public ClientOverrideConfiguration overrideConfiguration() {
                    return ClientOverrideConfiguration.builder().apiCallTimeout(Duration.ofMillis(500))
                            .build();
                }

                @Override
                public SdkHttpClient httpClient() {
                    return ApacheHttpClient.builder().connectionTimeout(Duration.ofMillis(1000)).build();
                }
            });
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration"><a class="link" href="#_configuration">Configuration</a></h3>
<div class="paragraph">
<p>The Spring Boot Starter for Secrets Manager provides the following configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.secretsmanager.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the Secrets Manager integration.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.secretsmanager.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures endpoint used by <code>SecretsManagerClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.secretsmanager.region</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures region used by <code>SecretsManagerClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_iam_permissions"><a class="link" href="#_iam_permissions">IAM Permissions</a></h3>
<div class="paragraph">
<p>Following IAM permissions are required by Spring Cloud AWS:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get secret value:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>secretsmanager:GetSecretValue</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Sample IAM policy granting access to Secrets Manager:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "secretsmanager:GetSecretValue",
            "Resource": "yourArn"
        }
    ]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<link rel="stylesheet" href="js/highlight/styles/github.min.css">
<script src="js/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
</body>
</html>