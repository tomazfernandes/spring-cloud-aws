<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Spring Cloud AWS</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}

</style>
<script type="text/javascript">
function addBlockSwitches() {
	for (var primary of document.querySelectorAll('.primary')) {
		var switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		var title = primary.querySelector('.title')
		title.remove();
	}
	for (var secondary of document.querySelectorAll('.secondary')) {
		var primary = findPrimary(secondary);
		if (primary === null) {
			console.error("Found secondary block with no primary sibling");
		}
		else {
			var switchItem = createSwitchItem(secondary, primary.querySelector('.switch'));
			switchItem.content.classList.add("hidden");
			primary.append(switchItem.content);
			secondary.remove();
		}
	}
}

function createElementFromHtml(html) {
	var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.firstChild;
}

function createBlockSwitch(primary) {
    var blockSwitch = createElementFromHtml('<div class="switch"></div>');
    primary.prepend(blockSwitch)
	return blockSwitch;
}

function findPrimary(secondary) {
	var candidate = secondary.previousElementSibling;
	while (candidate != null && !candidate.classList.contains('primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	var blockName = block.querySelector('.title').textContent;
	var content = block.querySelectorAll('.content').item(0);
	var colist = nextSibling(block, '.colist');
	if (colist != null) {
		content.append(colist);
	}
	var item = createElementFromHtml('<div class="switch--item">' + blockName + '</div>');
	item.dataset.blockName = blockName;
	content.dataset.blockName = blockName;
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function nextSibling(element, selector) {
	var sibling = element.nextElementSibling;
	while (sibling) {
		if (sibling.matches(selector)) {
			return sibling;
		}
		sibling = sibling.nextElementSibling;
	}
}

function globalSwitch() {
	document.querySelectorAll(".switch--item").forEach(function(item) {
		var blockId = blockIdForSwitchItem(item);
		var handler = function(event) {
			selectedText = event.target.textContent;
			window.localStorage.setItem(blockId, selectedText);
			for (var switchItem of document.querySelectorAll(".switch--item")) {
				if (blockIdForSwitchItem(switchItem) === blockId && switchItem.textContent === selectedText) {
					select(switchItem);
				}
			}
		}
		item.addEventListener("click", handler);
		if (item.textContent === window.localStorage.getItem(blockId)) {
			select(item);
		}
	});
}

function select(selected) {
	for (var child of selected.parentNode.children) {
		child.classList.remove("selected");
	}
	selected.classList.add("selected");
	for (var child of selected.parentNode.parentNode.children) {
		if (child.classList.contains("content")) {
			if (selected.dataset.blockName === child.dataset.blockName) {
				child.classList.remove("hidden");
			}
			else {
				child.classList.add("hidden");
			}
		}
	}	
}

function blockIdForSwitchItem(item) {
	idComponents = []
	for (var switchItem of item.parentNode.querySelectorAll(".switch--item")) {
		idComponents.push(switchItem.textContent.toLowerCase());
	}
	return idComponents.sort().join("-")
}

window.onload = function() {
	addBlockSwitches();
	globalSwitch();
};

</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Spring Cloud AWS</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#using-amazon-web-services">1. Using Amazon Web Services</a></li>
<li><a href="#getting-started">2. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#bill-of-materials">2.1. Bill of Materials</a></li>
<li><a href="#starter-dependencies">2.2. Starter Dependencies</a></li>
<li><a href="#choosing-aws-sdk-version">2.3. Choosing AWS SDK version</a></li>
</ul>
</li>
<li><a href="#spring-cloud-aws-core">3. Spring Cloud AWS Core</a>
<ul class="sectlevel2">
<li><a href="#credentials">3.1. Credentials</a></li>
<li><a href="#region">3.2. Region</a></li>
<li><a href="#endpoint">3.3. Endpoint</a></li>
<li><a href="#customizing-aws-clients">3.4. Customizing AWS Clients</a></li>
</ul>
</li>
<li><a href="#spring-cloud-aws-dynamoDb">4. DynamoDb Integration</a>
<ul class="sectlevel2">
<li><a href="#dynamodboperations">4.1. DynamoDbOperations</a>
<ul class="sectlevel3">
<li><a href="#resolving-table-name">4.1.1. Resolving Table Name</a></li>
<li><a href="#resolving-table-schema">4.1.2. Resolving Table Schema</a></li>
</ul>
</li>
<li><a href="#using-dynamodb-client">4.2. Using DynamoDb Client</a></li>
<li><a href="#using-dynamodb-accelerator">4.3. Using DynamoDB Accelerator</a></li>
<li><a href="#configuration">4.4. Configuration</a></li>
<li><a href="#iam-permissions">4.5. IAM Permissions</a></li>
</ul>
</li>
<li><a href="#spring-cloud-aws-s3">5. S3 Integration</a>
<ul class="sectlevel2">
<li><a href="#using-s3-client">5.1. Using S3 client</a></li>
<li><a href="#using-s3transfermanager">5.2. Using S3TransferManager</a></li>
<li><a href="#using-cross-region-s3-client">5.3. Using Cross-Region S3 client</a></li>
<li><a href="#s3-objects-as-spring-resources">5.4. S3 Objects as Spring Resources</a></li>
<li><a href="#using-s3template">5.5. Using S3Template</a></li>
<li><a href="#determining-s3-objects-content-type">5.6. Determining S3 Objects Content Type</a></li>
<li><a href="#configuration-2">5.7. Configuration</a></li>
<li><a href="#iam-permissions-2">5.8. IAM Permissions</a></li>
</ul>
</li>
<li><a href="#spring-cloud-aws-ses">6. SES Integration</a>
<ul class="sectlevel2">
<li><a href="#sending-simple-mails">6.1. Sending simple mails</a></li>
<li><a href="#sending-attachments">6.2. Sending attachments</a></li>
<li><a href="#authenticating-e-mails">6.3. Authenticating e-mails</a></li>
<li><a href="#configuration-3">6.4. Configuration</a></li>
<li><a href="#iam-permissions-3">6.5. IAM Permissions</a></li>
</ul>
</li>
<li><a href="#spring-cloud-aws-sns">7. SNS Integration</a>
<ul class="sectlevel2">
<li><a href="#sending-notifications">7.1. Sending Notifications</a>
<ul class="sectlevel3">
<li><a href="#sns-template">7.1.1. SNS Template</a></li>
<li><a href="#sns-operations">7.1.2. SNS Operations</a></li>
</ul>
</li>
<li><a href="#using-sns-client">7.2. Using SNS Client</a></li>
<li><a href="#annotation-driven-http-notification-endpoint">7.3. Annotation-driven HTTP notification endpoint</a></li>
<li><a href="#configuration-4">7.4. Configuration</a></li>
<li><a href="#iam-permissions-4">7.5. IAM Permissions</a></li>
</ul>
</li>
<li><a href="#sqs-support">8. SQS Support</a>
<ul class="sectlevel2">
<li><a href="#sample-listener-application">8.1. Sample Listener Application</a></li>
<li><a href="#sending-messages">8.2. Sending Messages</a></li>
<li><a href="#receiving-messages">8.3. Receiving Messages</a>
<ul class="sectlevel3">
<li><a href="#message-listeners">8.3.1. Message Listeners</a></li>
<li><a href="#sqsmessagelistenercontainer">8.3.2. SqsMessageListenerContainer</a></li>
<li><a href="#sqsmessagelistenercontainerfactory">8.3.3. SqsMessageListenerContainerFactory</a></li>
<li><a href="#sqslistener-annotation">8.3.4. @SqsListener Annotation</a>
<ul class="sectlevel4">
<li><a href="#queue-names">Queue Names</a></li>
<li><a href="#specifying-a-messagelistenercontainerfactory">Specifying a MessageListenerContainerFactory</a></li>
<li><a href="#other-annotation-properties">Other Annotation Properties</a></li>
<li><a href="#listener-method-arguments">Listener Method Arguments</a></li>
</ul>
</li>
<li><a href="#batch-processing">8.3.5. Batch Processing</a></li>
<li><a href="#container-options">8.3.6. Container Options</a>
<ul class="sectlevel4">
<li><a href="#using-auto-configuration">Using Auto-Configuration</a></li>
<li><a href="#containeroptions-descriptions">ContainerOptions Descriptions</a></li>
</ul>
</li>
<li><a href="#retrieving-attributes-from-sqs">8.3.7. Retrieving Attributes from SQS</a></li>
<li><a href="#container-lifecycle">8.3.8. Container Lifecycle</a>
<ul class="sectlevel4">
<li><a href="#containers-as-spring-beans">Containers as Spring Beans</a></li>
<li><a href="#retrieving-containers-from-the-registry">Retrieving Containers from the Registry</a></li>
<li><a href="#lifecycle-execution">Lifecycle Execution</a></li>
</ul>
</li>
<li><a href="#fifo-support">8.3.9. FIFO Support</a></li>
</ul>
</li>
<li><a href="#message-interceptor">8.4. Message Interceptor</a></li>
<li><a href="#error-handling">8.5. Error Handling</a></li>
<li><a href="#message-conversion-and-payload-deserialization">8.6. Message Conversion and Payload Deserialization</a>
<ul class="sectlevel3">
<li><a href="#configuring-a-messagingmessageconverter">8.6.1. Configuring a MessagingMessageConverter</a></li>
<li><a href="#interfaces-and-subclasses-in-listener-methods">8.6.2. Interfaces and Subclasses in Listener Methods</a></li>
</ul>
</li>
<li><a href="#acknowledging-messages">8.7. Acknowledging Messages</a>
<ul class="sectlevel3">
<li><a href="#acknowledgement-mode">8.7.1. Acknowledgement Mode</a></li>
<li><a href="#acknowledgement-batching">8.7.2. Acknowledgement Batching</a>
<ul class="sectlevel4">
<li><a href="#immediate-acknowledging">Immediate Acknowledging</a></li>
</ul>
</li>
<li><a href="#manual-acknowledgement">8.7.3. Manual Acknowledgement</a></li>
<li><a href="#acknowledgement-ordering">8.7.4. Acknowledgement Ordering</a></li>
<li><a href="#acknowledgement-defaults">8.7.5. Acknowledgement Defaults</a>
<ul class="sectlevel4">
<li><a href="#standard-sqs">Standard SQS</a></li>
<li><a href="#fifo-sqs">FIFO SQS</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#global-configuration-for-sqslisteners">8.8. Global Configuration for @SqsListeners</a></li>
<li><a href="#message-processing-throughput">8.9. Message Processing Throughput</a>
<ul class="sectlevel3">
<li><a href="#containeroptions-and-sqslistener-properties">8.9.1. ContainerOptions and <code>@SqsListener</code> properties</a>
<ul class="sectlevel4">
<li><a href="#maxinflightmessagesperqueue">maxInflightMessagesPerQueue</a></li>
<li><a href="#maxmessagesperpoll">maxMessagesPerPoll</a></li>
<li><a href="#polltimeout">pollTimeout</a></li>
<li><a href="#permitacquiretimeout">permitAcquireTimeout</a></li>
</ul>
</li>
<li><a href="#default-polling-behavior">8.9.2. Default Polling Behavior</a></li>
<li><a href="#configuring-backpressuremode">8.9.3. Configuring BackPressureMode</a></li>
</ul>
</li>
<li><a href="#blocking-and-non-blocking-async-components">8.10. Blocking and Non-Blocking (Async) Components</a>
<ul class="sectlevel3">
<li><a href="#threading-and-blocking-components">8.10.1. Threading and Blocking Components</a></li>
<li><a href="#providing-a-taskexecutor">8.10.2. Providing a TaskExecutor</a></li>
</ul>
</li>
<li><a href="#iam-permissions-5">8.11. IAM Permissions</a></li>
</ul>
</li>
<li><a href="#spring-cloud-aws-secrets-manager">9. Secrets Manager Integration</a>
<ul class="sectlevel2">
<li><a href="#loading-external-configuration">9.1. Loading External Configuration</a>
<ul class="sectlevel3">
<li><a href="#using-key-value-json-secrets">9.1.1. Using Key-Value (JSON) Secrets</a></li>
<li><a href="#using-plain-text-secrets">9.1.2. Using plain text secrets</a></li>
</ul>
</li>
<li><a href="#using-secretsmanagerclient">9.2. Using SecretsManagerClient</a></li>
<li><a href="#customizing-secretsmanagerclient">9.3. Customizing SecretsManagerClient</a></li>
<li><a href="#configuration-5">9.4. Configuration</a></li>
<li><a href="#iam-permissions-6">9.5. IAM Permissions</a></li>
</ul>
</li>
<li><a href="#spring-cloud-aws-parameter-store">10. Parameter Store Integration</a>
<ul class="sectlevel2">
<li><a href="#loading-external-configuration-2">10.1. Loading External Configuration</a></li>
<li><a href="#using-ssmclient">10.2. Using SsmClient</a></li>
<li><a href="#customizing-ssmclient">10.3. Customizing SsmClient</a></li>
<li><a href="#configuration-6">10.4. Configuration</a></li>
<li><a href="#iam-permissions-7">10.5. IAM Permissions</a></li>
</ul>
</li>
<li><a href="#configuration-properties">11. Configuration properties</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud AWS simplifies using AWS managed services in a Spring and Spring Boot applications. It offers a convenient way to interact with AWS provided services using well-known Spring idioms and APIs.</p>
</div>
<div class="paragraph">
<p><strong>3.0.0-SNAPSHOT</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Cloud is released under the non-restrictive Apache 2.0 license. If you would like to contribute to this section of the documentation or if you find an error, please find the source code and issue trackers in the project at <a href="https://github.com/spring-cloud/spring-cloud-aws">github</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-amazon-web-services"><a class="anchor" href="#using-amazon-web-services"></a><a class="link" href="#using-amazon-web-services">1. Using Amazon Web Services</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>AWS provides a <a href="https://aws.amazon.com/sdk-for-java/">Java SDK</a> to issue requests for the all services provided by the
<a href="https://aws.amazon.com">Amazon Web Service</a> platform. While the SDK offers all functionality available on AWS, there is a considerable amount of low level code needed to use it in Spring idiomatic way.
Spring Cloud AWS provides application developers already integrated Spring-based modules to consume the most popular AWS services and avoid low level code as much as possible.</p>
</div>
<div class="paragraph">
<p>Thanks to Spring Cloud AWS modularity you can include only dependencies relevant to the particular AWS service you want to integrate with.</p>
</div>
<div class="paragraph">
<p>Spring Cloud AWS lets you leverage the power and simplicity of the Spring Framework to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Write and read from Spring Resources backed up by S3</p>
</li>
<li>
<p>Send emails using SES</p>
</li>
<li>
<p>Import environment configuration using <a href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/context/config/ConfigDataLoader.html">ConfigDataLoader</a> from Parameter Store and Secrets Manager</p>
</li>
<li>
<p>Send and receive HTTP notifications from SNS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Other integrations are under development.</p>
</div>
<div class="paragraph">
<p>It also simplifies creating any non-integrated AWS SDK client by auto-configuring region and credentials providers.</p>
</div>
<div class="paragraph">
<p>That being said, it is perfectly valid option to use AWS SDK without using Spring Cloud AWS.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note, that Spring provides support for other AWS services in following projects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/spring-cloud/spring-cloud-stream-binder-aws-kinesis">Spring Cloud Stream Binder AWS Kinesis</a></p>
</li>
<li>
<p><a href="https://github.com/spring-cloud/spring-cloud-config">Spring Cloud Config Server</a> supports AWS Parameter Store and Secrets Manager</p>
</li>
<li>
<p><a href="https://github.com/spring-projects/spring-integration-aws">Spring Integration for AWS</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a><a class="link" href="#getting-started">2. Getting Started</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to get up to speed with Spring Cloud AWS libraries.</p>
</div>
<div class="sect2">
<h3 id="bill-of-materials"><a class="anchor" href="#bill-of-materials"></a><a class="link" href="#bill-of-materials">2.1. Bill of Materials</a></h3>
<div class="paragraph">
<p>The Spring Cloud AWS Bill of Materials (BOM) contains the versions of all the dependencies it uses.</p>
</div>
<div class="paragraph">
<p>If you’re a Maven user, adding the following to your <code>pom.xml</code> file will allow you omit any Spring Cloud AWS dependency version numbers from your configuration. Instead, the version of the BOM you’re using determines the versions of the used dependencies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-aws-dependencies&lt;/artifactId&gt;
            &lt;version&gt;{project-version}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle users can achieve the same kind of BOM experience using Spring’s <a href="https://github.com/spring-gradle-plugins/dependency-management-plugin">dependency-management-plugin</a> Gradle plugin. For simplicity, the Gradle dependency snippets in the remainder of this document will also omit their versions.</p>
</div>
</div>
<div class="sect2">
<h3 id="starter-dependencies"><a class="anchor" href="#starter-dependencies"></a><a class="link" href="#starter-dependencies">2.2. Starter Dependencies</a></h3>
<div class="paragraph">
<p>Spring Cloud AWS offers <a href="https://github.com/awspring/spring-cloud-aws/tree/main/spring-cloud-aws-starters">starter dependencies</a> through Maven to easily depend on different modules of the library.
Each starter contains all the dependencies and transitive dependencies needed to begin using their corresponding Spring Cloud AWS module.</p>
</div>
<div class="paragraph">
<p>For example, if you wish to write a Spring application with S3, you would include the <code>spring-cloud-aws-starter-s3</code> dependency in your project.
You do <strong>not</strong> need to include the underlying <code>spring-cloud-aws-s3</code> dependency, because the <code>starter</code> dependency includes it.</p>
</div>
<div class="paragraph">
<p>A summary of these artifacts are provided below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Spring Cloud AWS Starter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Maven Artifact Name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Automatically configure authentication and region selection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.awspring.cloud:spring-cloud-aws-starter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">S3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides integrations with S3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.awspring.cloud:spring-cloud-aws-starter-s3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides integrations with SES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.awspring.cloud:spring-cloud-aws-starter-ses</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SNS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides integrations with SNS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.awspring.cloud:spring-cloud-aws-starter-sns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides integrations with SQS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.awspring.cloud:spring-cloud-aws-starter-sqs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter Store</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides integrations with AWS Parameter Store</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.awspring.cloud:spring-cloud-aws-starter-parameter-store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secrets Manager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides integrations with AWS Secrets manager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.awspring.cloud:spring-cloud-aws-starter-secrets-manager</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="choosing-aws-sdk-version"><a class="anchor" href="#choosing-aws-sdk-version"></a><a class="link" href="#choosing-aws-sdk-version">2.3. Choosing AWS SDK version</a></h3>
<div class="paragraph">
<p>The AWS SDK is released more frequently than Spring Cloud AWS. If you need to use a  newer version of the SDK than
the one configured by Spring Cloud AWS, add the SDK BOM to the dependency management section making sure it is declared
before any other BOM dependency that configures AWS SDK dependencies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt;
            &lt;artifactId&gt;bom&lt;/artifactId&gt;
            &lt;version&gt;${aws-java-sdk.version}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-aws-core"><a class="anchor" href="#spring-cloud-aws-core"></a><a class="link" href="#spring-cloud-aws-core">3. Spring Cloud AWS Core</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each Spring Cloud AWS module uses <code>AwsCredentialsProvider</code> and <code>AwsRegionProvider</code> to get the AWS region and access credentials.</p>
</div>
<div class="paragraph">
<p>Spring Cloud AWS provides a Spring Boot starter to auto-configure the core components.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="getting-started.html#bill-of-materials">Spring Cloud AWS BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-aws-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="credentials"><a class="anchor" href="#credentials"></a><a class="link" href="#credentials">3.1. Credentials</a></h3>
<div class="paragraph">
<p><code>software.amazon.awssdk.auth.credentials.AwsCredentialsProvider</code> is a functional interface that returns the credentials to authenticate and authorize calls to AWS services.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface AwsCredentialsProvider {
    AwsCredentials resolveCredentials();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, Spring Cloud AWS starter auto-configures a <code>DefaultCredentialsProvider</code>, which looks for AWS credentials in this order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Java System Properties - <code>aws.accessKeyId</code> and <code>aws.secretAccessKey</code></p>
</li>
<li>
<p>Environment Variables - <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code></p>
</li>
<li>
<p>Web Identity Token credentials from system properties or environment variables</p>
</li>
<li>
<p>Credential profiles file at the default location (<code>~/.aws/credentials</code>) shared by all AWS SDKs and the AWS CLI</p>
</li>
<li>
<p>Credentials delivered through the Amazon EC2 container service if `AWS_CONTAINER_CREDENTIALS_RELATIVE_URI`" environment variable is set and security manager has permission to access the variable,</p>
</li>
<li>
<p>Instance profile credentials delivered through the Amazon EC2 metadata service</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If it does not serve your project needs, this behavior can be changed by setting additional properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">property</th>
<th class="tableblock halign-left valign-top">example</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.aws.credentials.access-key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AKIAIOSFODNN7EXAMPLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The access key to be used with a static provider</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.aws.credentials.secret-key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The secret key to be used with a static provider</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.aws.credentials.instance-profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures an <a href="https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/auth/credentials/InstanceProfileCredentialsProvider.html">InstanceProfileCredentialsProvider</a> with no further configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.aws.credentials.profile.name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of a configuration profile in the specified configuration file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.aws.credentials.profile.path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/.aws/credentials</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The file path where the profile configuration file is located. Defaults to <code>~/.aws/credentials</code> if value is not provided</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It is also possible to configure custom <code>AwsCredentialsProvider</code> bean which will prevent Spring Cloud AWS from auto-configuring credentials provider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;

@Configuration
class CustomCredentialsProviderConfiguration {

    @Bean
    public AwsCredentialsProvider customAwsCredentialsProvider() {
        return new CustomAWSCredentialsProvider();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="region"><a class="anchor" href="#region"></a><a class="link" href="#region">3.2. Region</a></h3>
<div class="paragraph">
<p><code>software.amazon.awssdk.regions.providers.AwsRegionProvider</code> is a functional interface that returns the region AWS clients issue requests to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface AwsRegionProvider {
    Region getRegion();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, Spring Cloud AWS starter auto-configures a <code>DefaultAwsRegionProviderChain</code>, which looks resolves AWS region in this order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check the <code>aws.region</code> system property for the region.</p>
</li>
<li>
<p>Check the <code>AWS_REGION</code> environment variable for the region.</p>
</li>
<li>
<p>Check the <code>{user.home}/.aws/credentials</code> and <code>{user.home}/.aws/config</code> files for the region.</p>
</li>
<li>
<p>If running in EC2, check the EC2 metadata service for the region.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If it does not serve your project needs, this behavior can be changed by setting additional properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">property</th>
<th class="tableblock halign-left valign-top">example</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.aws.region.static</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eu-west-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A static value for region used by auto-configured AWS clients</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.aws.region.instance-profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures an <a href="https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/regions/providers/InstanceProfileRegionProvider.html">InstanceProfileRegionProvider</a> with no further configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.aws.region.profile.name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of a configuration profile in the specified configuration file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring.cloud.aws.region.profile.path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~/.aws/credentials</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The file path where the profile configuration file is located. Defaults to <code>~/.aws/credentials</code> if value is not provided</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It is also possible to configure custom <code>AwsRegionProvider</code> bean which will prevent Spring Cloud AWS from auto-configuring region provider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import software.amazon.awssdk.regions.providers.AwsRegionProvider;

@Configuration
class CustomRegionProviderConfiguration {

    @Bean
    public AwsRegionProvider customRegionProvider() {
        return new CustomRegionProvider();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="endpoint"><a class="anchor" href="#endpoint"></a><a class="link" href="#endpoint">3.3. Endpoint</a></h3>
<div class="paragraph">
<p>To simplify using services with AWS compatible APIs, or running applications against <a href="https://localstack.cloud/">Localstack</a>, it is possible to configure an endpoint set on all auto-configured AWS clients:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">property</th>
<th class="tableblock halign-left valign-top">example</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://localhost:4566" class="bare">localhost:4566</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">endpoint url applied to auto-configured AWS clients</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="customizing-aws-clients"><a class="anchor" href="#customizing-aws-clients"></a><a class="link" href="#customizing-aws-clients">3.4. Customizing AWS Clients</a></h3>
<div class="paragraph">
<p>To configure an AWS client with custom HTTP client or <code>ClientOverrideConfiguration</code>, define a bean of type <code>AwsClientConfigurer</code> with a type parameter indicating configured client builder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import io.awspring.cloud.autoconfigure.core.AwsClientCustomizer;
import org.springframework.context.annotation.Bean;

import software.amazon.awssdk.core.client.config.ClientOverrideConfiguration;
import software.amazon.awssdk.http.SdkHttpClient;
import software.amazon.awssdk.http.apache.ApacheHttpClient;
import software.amazon.awssdk.services.sns.SnsClientBuilder;

import java.time.Duration;

@Configuration
class S3AwsClientConfigurerConfiguration {

    @Bean
    AwsClientCustomizer&lt;S3ClientBuilder&gt; s3ClientBuilderAwsClientConfigurer() {
        return new S3AwsClientClientConfigurer();
    }

    static class S3AwsClientClientConfigurer implements AwsClientCustomizer&lt;S3ClientBuilder&gt; {
        @Override
        public ClientOverrideConfiguration overrideConfiguration() {
            return ClientOverrideConfiguration.builder().apiCallTimeout(Duration.ofMillis(500)).build();
        }

        @Override
        public SdkHttpClient httpClient() {
            return ApacheHttpClient.builder().connectionTimeout(Duration.ofMillis(1000)).build();
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-aws-dynamoDb"><a class="anchor" href="#spring-cloud-aws-dynamoDb"></a><a class="link" href="#spring-cloud-aws-dynamoDb">4. DynamoDb Integration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://aws.amazon.com/dynamodb/">DynamoDb</a> is a fully managed serverless key/value Nosql database designed for high performance.
A Spring Boot starter is provided to auto-configure DynamoDb integration beans.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Cloud AWS BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-aws-starter-dynamodb&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>DynamoDb integration will only provide autoconfiguration and simple <code>DynamoDbOperations</code> which can be used to communicate with DynamoDb, build repositories and so on&#8230;&#8203;</p>
</div>
<div class="sect2">
<h3 id="dynamodboperations"><a class="anchor" href="#dynamodboperations"></a><a class="link" href="#dynamodboperations">4.1. DynamoDbOperations</a></h3>
<div class="paragraph">
<p>The starter automatically configures and registers a <code>DynamoDbOperations</code> bean providing higher level abstractions for working with DynamoDb.
<code>DynamoDbTemplate</code> - a default <code>DynamoDbOperations</code> implementation - being built on top of <code>DynamoDbEnhancedClient</code> uses annotations provided by AWS.
The list of supported annotations can be found <a href="https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/enhanced/dynamodb/mapper/annotations/package-summary.html">here</a>.</p>
</div>
<div class="paragraph">
<p><code>DynamoDbEnchancedClient</code> supports a programming model similar to JPA - where a class is turned into an entity through applying certain annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import java.util.UUID;
import software.amazon.awssdk.enhanced.dynamodb.mapper.annotations.DynamoDbBean;
import software.amazon.awssdk.enhanced.dynamodb.mapper.annotations.DynamoDbPartitionKey;

@DynamoDbBean
public class Person {
    private UUID id;
    private String name;
    private String lastName;

    @DynamoDbPartitionKey
    public UUID getId() {
        return id;
    }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>DynamoDbTemplate</code> provides methods to perform typical CRUD operations on such entities, plus it adds convenience methods for querying DynamoDb:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import io.awspring.cloud.dynamodb.DynamoDbTemplate;

...
@Autowired
DynamoDbTemplate dynamoDbTemplate;
...
Person person = new Person(...)
dynamoDbTemplate.save(person);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="resolving-table-name"><a class="anchor" href="#resolving-table-name"></a><a class="link" href="#resolving-table-name">4.1.1. Resolving Table Name</a></h4>
<div class="paragraph">
<p>To resolve a table name for an entity, <code>DynamoDbTemplate</code> uses a bean of type <code>DynamoDbTableNameResolver</code>. The default implementation turns an entity class name into its snake case representation.
To use custom implementation, declare a bean of type <code>DynamoDbTableNameResolver</code> and it will get injected into <code>DynamoDbTemplate</code> automatically during auto-configuration.</p>
</div>
</div>
<div class="sect3">
<h4 id="resolving-table-schema"><a class="anchor" href="#resolving-table-schema"></a><a class="link" href="#resolving-table-schema">4.1.2. Resolving Table Schema</a></h4>
<div class="paragraph">
<p>To resolve a table schema for an entity, <code>DynamoDbTemplate</code> uses a bean of type <code>DynamoDbTableSchemaResolver</code>. The default implementation caches <code>TableSchema</code> objects in internal map.
To use custom implementation, declare a bean of type <code>DynamoDbTableSchemaResolver</code> and it will get injected into <code>DynamoDbTemplate</code> automatically during auto-configuration.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-dynamodb-client"><a class="anchor" href="#using-dynamodb-client"></a><a class="link" href="#using-dynamodb-client">4.2. Using DynamoDb Client</a></h3>
<div class="paragraph">
<p>Autoconfiguration automatically configures <code>DynamoDbClient</code> which can be used for low level api calls and <code>DynamoDbEnhancedClient</code> if <code>DynamoDbOperations</code> are not enough.</p>
</div>
<div class="paragraph">
<p>If autoconfigured <code>DynamoDbClient</code> or <code>DynamoDbEnhancedClient</code> bean configuration does not meet your needs, it can be replaced by creating your custom bean.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import java.util.Collections;
import software.amazon.awssdk.services.dynamodb.DynamoDbClient;
import software.amazon.awssdk.services.dynamodb.model.AttributeValue;
import software.amazon.awssdk.services.dynamodb.model.DeleteItemRequest;

public class DynamoDbService {
    private final DynamoDbClient dynamoDbClient;

    public DynamoDbService(DynamoDbClient dynamoDbClient) {
        this.dynamoDbClient = dynamoDbClient;
    }

    void deletePerson(String uuid) {
        dynamoDbClient.deleteItem(DeleteItemRequest.builder().key(Collections.singletonMap("uuid", AttributeValue.builder().s(uuid).build())).build());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-dynamodb-accelerator"><a class="anchor" href="#using-dynamodb-accelerator"></a><a class="link" href="#using-dynamodb-accelerator">4.3. Using DynamoDB Accelerator</a></h3>
<div class="paragraph">
<p>The starter automatically configures and registers an <code>software.amazon.dax.ClusterDaxClient</code> bean if it finds the following is added to the project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;software.amazon.dax&lt;/groupId&gt;
    &lt;artifactId&gt;amazon-dax-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration"><a class="anchor" href="#configuration"></a><a class="link" href="#configuration">4.4. Configuration</a></h3>
<div class="paragraph">
<p>The Spring Boot Starter for DynamoDb provides the following configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 37.5%;">
<col style="width: 37.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the DynamoDb integration.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures endpoint used by <code>DynamoDbClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.region</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures region used by <code>DynamoDbClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.idle-timeout-millis</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout for idle connections with the DAX cluster.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>30000</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DAX cluster endpoint.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.connection-ttl-millis</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection time to live.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.connect-timeout-millis</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1000</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.request-timeout-millis</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request timeout for connections with the DAX cluster.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1000</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.write-retries</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of times to retry writes, initial try is not counted.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.read-retries</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of times to retry reads, initial try is not counted.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.cluster-update-interval-millis</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interval between polling of cluster members for membership changes.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>4000</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.endpoint-refresh-timeout-millis</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout for endpoint refresh.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>6000</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.max-concurrency</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of concurrent requests.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.max-pending-connection-acquires</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of pending Connections to acquire.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.dynamodb.dax.skip-host-name-verification</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Skips hostname verification in url.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="iam-permissions"><a class="anchor" href="#iam-permissions"></a><a class="link" href="#iam-permissions">4.5. IAM Permissions</a></h3>
<div class="paragraph">
<p>Since it depends on how you will use DynamoDb integration providing a list of IAM policies would be pointless since least privilege model should be used.
To check what IAM policies DynamoDb uses and see which ones you should use please check <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/using-identity-based-policies.html">IAM policies</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-aws-s3"><a class="anchor" href="#spring-cloud-aws-s3"></a><a class="link" href="#spring-cloud-aws-s3">5. S3 Integration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://aws.amazon.com/s3/">S3</a> allows storing files in a cloud.
A Spring Boot starter is provided to auto-configure the various S3 integration related components.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Cloud AWS BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-aws-s3&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="using-s3-client"><a class="anchor" href="#using-s3-client"></a><a class="link" href="#using-s3-client">5.1. Using S3 client</a></h3>
<div class="paragraph">
<p>The starter automatically configures and registers a <code>S3Client</code> bean in the Spring application context. The <code>S3Client</code> bean can be used to perform operations on S3 buckets and objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import java.io.IOException;
import java.nio.charset.StandardCharsets;

import software.amazon.awssdk.core.ResponseInputStream;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.model.GetObjectResponse;

import org.springframework.stereotype.Component;
import org.springframework.util.StreamUtils;

@Component
class S3ClientSample {
    private final S3Client s3Client;

    S3ClientSample(S3Client s3Client) {
        this.s3Client = s3Client;
    }

    void readFile() throws IOException {
        ResponseInputStream&lt;GetObjectResponse&gt; response = s3Client.getObject(
            request -&gt; request.bucket("bucket-name").key("file-name.txt"));

        String fileContent = StreamUtils.copyToString(response, StandardCharsets.UTF_8);

        System.out.println(fileContent);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-s3transfermanager"><a class="anchor" href="#using-s3transfermanager"></a><a class="link" href="#using-s3transfermanager">5.2. Using S3TransferManager</a></h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>S3 Transfer Manager provided by AWS is in developer preview phase and should not be used in production.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>AWS launched <a href="https://aws.amazon.com/blogs/developer/introducing-amazon-s3-transfer-manager-in-the-aws-sdk-for-java-2-x/">a high level file transfer utility</a>, called Transfer Manager. The starter automatically configures and registers an <code>software.amazon.awssdk.transfer.s3.S3TransferManager</code> bean if it finds the following is added to the project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
  &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt;
  &lt;artifactId&gt;s3-transfer-manager&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-cross-region-s3-client"><a class="anchor" href="#using-cross-region-s3-client"></a><a class="link" href="#using-cross-region-s3-client">5.3. Using Cross-Region S3 client</a></h3>
<div class="paragraph">
<p><code>S3Client</code> implementation provided in AWS SDK is region specific - meaning it can be used only to operate on buckets and objects stored in region for which the client has been configured to use.</p>
</div>
<div class="paragraph">
<p>For example, assuming that <code>DefaultAwsRegionProviderChain</code> resolves a region <code>us-east-1</code>, running any S3 operation that uses a bucket created in another region would result in an exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">software.amazon.awssdk.services.s3.model.S3Exception: The bucket you are attempting to access must be addressed using the specified endpoint. Please send all future requests to this endpoint. (Service: S3, Status Code: 301, Request ID: ..., Extended Request ID: ...)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring Cloud AWS provides a <code>CrossRegionS3Client</code> that solves this problem by maintaining an internal dictionary of <code>S3Client</code> objects per region. If you need to customize these clients, you can create a custom <code>S3ClientBuilder</code> bean that acts as a template to create region-specific S3 clients in <code>CrossRegionS3Client</code>.
There is no extra work needed to use cross-region S3 client - it is the <code>S3Client</code> auto-configured by Spring Cloud AWS.</p>
</div>
<div class="paragraph">
<p>To disable <code>CrossRegionS3Client</code> creation and use instead a regular region-specific <code>S3Client</code>, you can either create a custom <code>S3Client</code> bean, or exclude <code>spring-cloud-aws-s3-cross-region-client</code> dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-aws-s3&lt;/artifactId&gt;
    &lt;exclusions&gt;
        &lt;exclusion&gt;
            &lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-aws-s3-cross-region-client&lt;/artifactId&gt;
        &lt;/exclusion&gt;
    &lt;/exclusions&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="s3-objects-as-spring-resources"><a class="anchor" href="#s3-objects-as-spring-resources"></a><a class="link" href="#s3-objects-as-spring-resources">5.4. S3 Objects as Spring Resources</a></h3>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/resources.html">Spring Resources</a> are an abstraction for a number of low-level resources, such as file system files, classpath files, servlet context-relative files, etc.
Spring Cloud AWS adds a new resource type: a <code>S3Resource</code> object.</p>
</div>
<div class="paragraph">
<p>The Spring Resource Abstraction for S3 allows S3 objects to be accessed by their S3 URL using the <code>@Value</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value("s3://[S3_BUCKET_NAME]/[FILE_NAME]")
private Resource s3Resource;</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;or the Spring application context</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">SpringApplication.run(...).getResource("s3://[S3_BUCKET_NAME]/[FILE_NAME]");</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a <code>Resource</code> object that can be used to read the file, among <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/resources.html#resources-resource">other possible operations</a>.</p>
</div>
<div class="paragraph">
<p>It is also possible to write to a <code>Resource</code>, although a <code>WriteableResource</code> is required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value("s3://[S3_BUCKET_NAME]/[FILE_NAME]")
private Resource s3Resource;
...
try (OutputStream os = ((WritableResource) s3Resource).getOutputStream()) {
  os.write("content".getBytes());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To work with the <code>Resource</code> as a S3 resource, cast it to <code>io.awspring.cloud.s3.S3Resource</code>.
Using <code>S3Resource</code> directly lets you set the <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingMetadata.html">S3 object metadata</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value("s3://[S3_BUCKET_NAME]/[FILE_NAME]")
private Resource s3Resource;
...
ObjectMetadata objectMetadata = ObjectMetadata.builder()
    .contentType("application/json")
    .serverSideEncryption(ServerSideEncryption.AES256)
    .build();
s3Resource.setObjectMetadata(objectMetadata);
try (OutputStream outputStream = s3Resource.getOutputStream()) {
    outputStream.write("content".getBytes(StandardCharsets.UTF_8));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Under the hood by default <code>S3Resource</code> uses a <code>io.awspring.cloud.s3.InMemoryBufferingS3OutputStream</code>. When data is written to the resource, is gets sent to S3 using multipart upload.
If a network error occurs during upload, <code>S3Client</code> has a built-in retry mechanism that will retry each failed part. If the upload fails after retries, multipart upload gets aborted and <code>S3Resource</code> throws <code>io.awspring.cloud.s3.S3Exception</code>.</p>
</div>
<div class="paragraph">
<p>If <code>InMemoryBufferingS3OutputStream</code> behavior does not fit your needs, you can use <code>io.awspring.cloud.s3.DiskBufferingS3OutputStream</code> by defining a bean of type <code>DiskBufferingS3OutputStreamProvider</code> which will override the default output stream provider.
With <code>DiskBufferingS3OutputStream</code> when data is written to the resource, first it is stored on the disk in a <code>tmp</code> directory in the OS. Once the stream gets closed, the file gets uploaded with <a href="https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/services/s3/S3Client.html#putObject-java.util.function.Consumer-java.nio.file.Path-">S3Client#putObject</a> method.
If a network error occurs during upload, <code>S3Client</code> has a built-in retry mechanism. If the upload fails after retries, <code>S3Resource</code> throws <code>io.awspring.cloud.s3.UploadFailed</code> exception containing a file location in a temporary directory in a file system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">try (OutputStream outputStream = s3Resource.getOutputStream()) {
    outputStream.write("content".getBytes(StandardCharsets.UTF_8));
} catch (UploadFailedException e) {
    // e.getPath contains a file location in temporary folder
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using the <code>S3TransferManager</code>, the default implementation will switch to <code>io.awspring.cloud.s3.TransferManagerS3OutputStream</code>. This OutputStream also uses a temporary file to write it on disk before uploading it to S3, but it may be faster as it uses a multi-part upload under the hood.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-s3template"><a class="anchor" href="#using-s3template"></a><a class="link" href="#using-s3template">5.5. Using S3Template</a></h3>
<div class="paragraph">
<p>Spring Cloud AWS provides a higher abstraction on the top of <code>S3Client</code> providing methods for the most common use cases when working with S3.</p>
</div>
<div class="paragraph">
<p>On the top of self-explanatory methods for creating and deleting buckets, <code>S3Template</code> provides a simple methods for uploading and downloading files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
private S3Template s3Template;

InputStream is = ...
// uploading file without metadata
s3Template.upload(BUCKET, "file.txt", is);

// uploading file with metadata
s3Template.upload(BUCKET, "file.txt", is, ObjectMetadata.builder().contentType("text/plain").build());</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>S3Template</code> also allows storing &amp; retrieving Java objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Person p = new Person("John", "Doe");
s3Template.store(BUCKET, "person.json", p);

Person loadedPerson = s3Template.read(BUCKET, "person.json", Person.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, if Jackson is on the classpath, <code>S3Template</code> uses <code>ObjectMapper</code> based <code>Jackson2JsonS3ObjectConverter</code> to convert from S3 object to Java object and vice versa.
This behavior can be overwritten by providing custom bean of type <code>S3ObjectConverter</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="determining-s3-objects-content-type"><a class="anchor" href="#determining-s3-objects-content-type"></a><a class="link" href="#determining-s3-objects-content-type">5.6. Determining S3 Objects Content Type</a></h3>
<div class="paragraph">
<p>All S3 objects stored in S3 through <code>S3Template</code>, <code>S3Resource</code> or <code>S3OutputStream</code> automatically get set a <code>contentType</code> property on the S3 object metadata, based on the S3 object key (file name).</p>
</div>
<div class="paragraph">
<p>By default, <code>PropertiesS3ObjectContentTypeResolver</code> - a component supporting over 800 file extensions is responsible for content type resolution.
If this content type resolution does not meet your needs, you can provide a custom bean of type <code>S3ObjectContentTypeResolver</code> which will be automatically used in all components responsible for uploading files.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuration-2"><a class="anchor" href="#configuration-2"></a><a class="link" href="#configuration-2">5.7. Configuration</a></h3>
<div class="paragraph">
<p>The Spring Boot Starter for S3 provides the following configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.s3.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the S3 integration.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.s3.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures endpoint used by <code>S3Client</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://localhost:4566" class="bare">localhost:4566</a></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.s3.region</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures region used by <code>S3Client</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eu-west-1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.s3.accelerate-mode-enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Option to enable using the accelerate endpoint when accessing S3. Accelerate endpoints allow faster transfer of objects by using Amazon CloudFront&#8217;s globally distributed edge locations.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code> (falls back to SDK default)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.s3.checksum-validation-enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Option to disable doing a validation of the checksum of an object stored in S3.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code> (falls back to SDK default)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.s3.chunked-encoding-enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Option to enable using chunked encoding when signing the request payload for <code>PutObjectRequest</code> and <code>UploadPartRequest</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code> (falls back to SDK default)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.s3.path-style-access-enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Option to enable using path style access for accessing S3 objects instead of DNS style access. DNS style access is preferred as it will result in better load balancing when accessing S3.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code> (falls back to SDK default)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.s3.use-arn-region-enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If an S3 resource ARN is passed in as the target of an S3 operation that has a different region to the one the client was configured with, this flag must be set to 'true' to permit the client to make a cross-region call to the region specified in the ARN otherwise an exception will be thrown.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code> (falls back to SDK default)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="iam-permissions-2"><a class="anchor" href="#iam-permissions-2"></a><a class="link" href="#iam-permissions-2">5.8. IAM Permissions</a></h3>
<div class="paragraph">
<p>Following IAM permissions are required by Spring Cloud AWS:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 66.6666%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Downloading files</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>s3:GetObject</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Searching files</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>s3:ListObjects</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uploading files</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>s3:PutObject</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Sample IAM policy granting access to <code>spring-cloud-aws-demo</code> bucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::spring-cloud-aws-demo"
        },
        {
            "Effect": "Allow",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::spring-cloud-aws-demo/*"
        },
        {
            "Effect": "Allow",
            "Action": "s3:PutObject",
            "Resource": "arn:aws:s3:::spring-cloud-aws-demo/*"
        }
    ]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-aws-ses"><a class="anchor" href="#spring-cloud-aws-ses"></a><a class="link" href="#spring-cloud-aws-ses">6. SES Integration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring has a built-in support to send e-mails based on the <a href="https://www.oracle.com/technetwork/java/javamail/index.html">Java Mail API</a>
to avoid any static method calls while using the Java Mail API and thus supporting the testability of an application.
Spring Cloud AWS supports the <a href="https://aws.amazon.com/de/ses/">Amazon SES</a> as an implementation of the Spring Mail abstraction.</p>
</div>
<div class="paragraph">
<p>As a result Spring Cloud AWS users can decide to use the Spring Cloud AWS implementation of the Amazon SES service or
use the standard Java Mail API based implementation that sends e-mails via SMTP to Amazon SES.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is preferred to use the Spring Cloud AWS implementation instead of SMTP mainly for performance reasons.
Spring Cloud AWS uses one API call to send a mail message, while the SMTP protocol makes multiple requests (EHLO, MAIL FROM, RCPT TO, DATA, QUIT)
until it sends an e-mail.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A Spring Boot starter is provided to auto-configure SES integration beans.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Cloud AWS BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-aws-starter-ses&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="sending-simple-mails"><a class="anchor" href="#sending-simple-mails"></a><a class="link" href="#sending-simple-mails">6.1. Sending simple mails</a></h3>
<div class="paragraph">
<p>Application developers can inject the <code>MailSender</code> into their application code and directly send simple text based e-mail
messages. The sample below demonstrates the creation of a simple mail message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import org.springframework.mail.MailSender;
import org.springframework.mail.SimpleMailMessage;

class MailSendingService {

    private final MailSender mailSender;

    public MailSendingService(MailSender mailSender) {
        this.mailSender = mailSender;
    }

    public void sendMailMessage() {
        SimpleMailMessage simpleMailMessage = new SimpleMailMessage();
        simpleMailMessage.setFrom("foo@bar.com");
        simpleMailMessage.setTo("bar@baz.com");
        simpleMailMessage.setSubject("test subject");
        simpleMailMessage.setText("test content");
        this.mailSender.send(simpleMailMessage);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sending-attachments"><a class="anchor" href="#sending-attachments"></a><a class="link" href="#sending-attachments">6.2. Sending attachments</a></h3>
<div class="paragraph">
<p>Sending attachments with e-mail requires MIME messages to be created and sent. In order to create MIME messages,
the Java Mail dependency is required and has to be included in the classpath. Spring Cloud AWS will detect the
dependency and create a <code>org.springframework.mail.javamail.JavaMailSender</code> implementation that allows to create and
build MIME messages and send them. A dependency configuration for the Java Mail API is the only change in the configuration
which is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;javax.mail&lt;/groupId&gt;
    &lt;artifactId&gt;mailapi&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even though there is a dependency to the Java Mail API there is still the Amazon SES API used underneath to send mail
messages. There is no <a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/send-email-smtp.html">SMTP setup</a> required
on the Amazon AWS side.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sending the mail requires the application developer to use the <code>JavaMailSender</code> to send an e-mail as shown in the example
below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.mail.javamail.MimeMessagePreparator;

class MailSendingService {

    private final JavaMailSender mailSender;

    public MailSendingService(JavaMailSender mailSender) {
        this.mailSender = mailSender;
    }

    public void sendMailMessage() {
        this.mailSender.send(new MimeMessagePreparator() {

            @Override
            public void prepare(MimeMessage mimeMessage) throws Exception {
                MimeMessageHelper helper =
                    new MimeMessageHelper(mimeMessage, true, "UTF-8");
                helper.addTo("foo@bar.com");
                helper.setFrom("bar@baz.com");
                helper.addAttachment("test.txt", ...);
                helper.setSubject("test subject with attachment");
                helper.setText("mime body", false);
            }
        });
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="authenticating-e-mails"><a class="anchor" href="#authenticating-e-mails"></a><a class="link" href="#authenticating-e-mails">6.3. Authenticating e-mails</a></h3>
<div class="paragraph">
<p>To avoid any spam attacks on the Amazon SES mail service, applications without production access must
<a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-email-addresses.html">verify</a> each
e-mail receiver otherwise the mail sender will throw a <code>software.amazon.awssdk.services.ses.model.MessageRejectedException</code>.</p>
</div>
<div class="paragraph">
<p><a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/request-production-access.html">Production access</a> can be requested
and will disable the need for mail address verification.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuration-3"><a class="anchor" href="#configuration-3"></a><a class="link" href="#configuration-3">6.4. Configuration</a></h3>
<div class="paragraph">
<p>The Spring Boot Starter for SES provides the following configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 37.5%;">
<col style="width: 37.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.ses.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the SES integration.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.ses.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures endpoint used by <code>SesClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.ses.region</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures region used by <code>SesClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Amazon SES is not available in all <a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/regions.html">regions</a> of the
Amazon Web Services cloud. Therefore, an application hosted and operated in a region that does not support the mail
service will produce an error while using the mail service. Therefore, the region must be overridden for the mail
sender configuration. The example below shows a typical combination of a region (<code>EU-CENTRAL-1</code>) that does not provide
an SES service where the client is overridden to use a valid region (<code>EU-WEST-1</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.cloud.aws.ses.region=eu-west-1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="iam-permissions-3"><a class="anchor" href="#iam-permissions-3"></a><a class="link" href="#iam-permissions-3">6.5. IAM Permissions</a></h3>
<div class="paragraph">
<p>Following IAM permissions are required by Spring Cloud AWS:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send e-mail without attachment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ses:SendEmail</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send e-mail with attachment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ses:SendRawEmail</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Sample IAM policy granting access to SES:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ses:SendEmail",
                "ses:SendRawEmail"
            ],
            "Resource": "arn:aws:ses:your:arn"
        }
    ]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-aws-sns"><a class="anchor" href="#spring-cloud-aws-sns"></a><a class="link" href="#spring-cloud-aws-sns">7. SNS Integration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://aws.amazon.com/sns/">SNS</a> is a pub/sub messaging service that allows clients to publish notifications to a particuluar topic.
A Spring Boot starter is provided to auto-configure SNS integration beans.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Cloud AWS BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-aws-starter-sns&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="sending-notifications"><a class="anchor" href="#sending-notifications"></a><a class="link" href="#sending-notifications">7.1. Sending Notifications</a></h3>
<div class="sect3">
<h4 id="sns-template"><a class="anchor" href="#sns-template"></a><a class="link" href="#sns-template">7.1.1. SNS Template</a></h4>
<div class="paragraph">
<p>The starter automatically configures and registers a <code>SnsTemplate</code> bean providing higher level abstractions for sending SNS notifications.
<code>SnsTemplate</code> implements Spring Messaging abstractions making it easy to combine with other messaging technologies compatible with Spring Messaging.</p>
</div>
<div class="paragraph">
<p>It supports sending notifications with payload of type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>String</code> - using <code>org.springframework.messaging.converter.StringMessageConverter</code></p>
</li>
<li>
<p><code>Object</code> - which gets serialized to JSON using <code>org.springframework.messaging.converter.MappingJackson2MessageConverter</code> and Jackson&#8217;s <code>com.fasterxml.jackson.databind.ObjectMapper</code> autoconfigured by Spring Boot.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, it exposes handful of methods supporting <code>org.springframework.messaging.Message</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import io.awspring.cloud.sns.core.SnsTemplate;

import org.springframework.messaging.Message;
import org.springframework.messaging.support.MessageBuilder;

class NotificationService {
    private final SnsTemplate snsTemplate;

    NotificationService(SnsTemplate snsTemplate) {
        this.snsTemplate = snsTemplate;
    }

    void sendNotification() {
        // sends String payload
        snsTemplate.sendNotification("topic-arn", "payload", "subject");
        // sends object serialized to JSON
        snsTemplate.sendNotification("topic-arn", new Person("John", "Doe"), "subject");
        // sends a Spring Messaging Message
        Message&lt;String&gt; message = MessageBuilder.withPayload("payload")
            .setHeader("header-name", "header-value")
            .build();
        snsTemplate.send("topic-arn", message);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If autoconfigured converters do not meet your needs, you can provide a custom <code>SnsTemplate</code> bean with a message converter of your choice.</p>
</div>
<div class="paragraph">
<p>When sending SNS notification, it is required to provide a topic ARN. Spring Cloud AWS simplifies it and allows providing a topic name instead, under a condition that topic with that name has already been created.
Otherwise, Spring Cloud AWS will make an attempt to create topic with this name with a first call.</p>
</div>
<div class="paragraph">
<p>The behavior of resolving topic ARN by a topic name can be altered by providing a custom bean of type <code>io.awspring.cloud.sns.core.TopicArnResolver</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sns-operations"><a class="anchor" href="#sns-operations"></a><a class="link" href="#sns-operations">7.1.2. SNS Operations</a></h4>
<div class="paragraph">
<p>Because of Spring Messaging compatibility, <code>SnsTemplate</code> exposes many methods that you may not need if you don&#8217;t need Spring Messaging abstractions.
In such case, we recommend using <code>SnsOperations</code> - an interface implemented by <code>SnsTemplate</code>, that exposes a convenient method for sending SNS notification, including support for FIFO topics.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import io.awspring.cloud.sns.core.SnsNotification;
import io.awspring.cloud.sns.core.SnsOperations;
import io.awspring.cloud.sns.core.SnsTemplate;

class NotificationService {
    private final SnsOperations snsOperations;

    NotificationService(SnsOperations snsOperations) {
        this.snsOperations = snsOperations;
    }

    void sendNotification() {
        SnsNotification&lt;Person&gt; notification = SnsNotification.builder(new Person("John", "Doe"))
            .deduplicationId("..")
            .groupId("..")
            .build();
        snsOperations.sendNotification("topic-arn", notification);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-sns-client"><a class="anchor" href="#using-sns-client"></a><a class="link" href="#using-sns-client">7.2. Using SNS Client</a></h3>
<div class="paragraph">
<p>To have access to all lower level SNS operations, we recommend using <code>SnsClient</code> from AWS SDK. <code>SnsClient</code> bean is autoconfigured by <code>SnsAutoConfiguration</code>.</p>
</div>
<div class="paragraph">
<p>If autoconfigured <code>SnsClient</code> bean configuration does not meet your needs, it can be replaced by creating a custom bean of type <code>SnsClient</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import software.amazon.awssdk.services.sns.SnsClient;

class NotificationService {
    private final SnsClient snsClient;

    public NotificationService(SnsClient snsClient) {
        this.snsClient = snsClient;
    }

    void sendNotification() {
        snsClient.publish(request -&gt; request.topicArn("sns-topic-arn").message("payload"));
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="annotation-driven-http-notification-endpoint"><a class="anchor" href="#annotation-driven-http-notification-endpoint"></a><a class="link" href="#annotation-driven-http-notification-endpoint">7.3. Annotation-driven HTTP notification endpoint</a></h3>
<div class="paragraph">
<p>SNS supports multiple endpoint types (SQS, Email, HTTP, HTTPS), Spring Cloud AWS provides support for HTTP(S) endpoints.
SNS sends three type of requests to an HTTP topic listener endpoint, for each of them annotations are provided:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Subscription request &#8594; <code>@NotificationSubscriptionMapping</code></p>
</li>
<li>
<p>Notification request &#8594; <code>@NotificationMessageMapping</code></p>
</li>
<li>
<p>Unsubscription request &#8594; <code>@NotificationUnsubscribeMapping</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>HTTP endpoints are based on Spring MVC controllers. Spring Cloud AWS added some custom argument resolvers to extract the message and subject out of the notification requests.</p>
</div>
<div class="paragraph">
<p>Example of integration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import io.awspring.cloud.sns.annotation.endpoint.NotificationMessageMapping;
import io.awspring.cloud.sns.annotation.endpoint.NotificationSubscriptionMapping;
import io.awspring.cloud.sns.annotation.endpoint.NotificationUnsubscribeConfirmationMapping;
import io.awspring.cloud.sns.annotation.handlers.NotificationMessage;
import io.awspring.cloud.sns.annotation.handlers.NotificationSubject;
import io.awspring.cloud.sns.handlers.NotificationStatus;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;

@Controller
@RequestMapping("/topicName")
public class NotificationTestController {

    @NotificationSubscriptionMapping
    public void handleSubscriptionMessage(NotificationStatus status) {
        //We subscribe to start receive the message
        status.confirmSubscription();
    }

    @NotificationMessageMapping
    public void handleNotificationMessage(@NotificationSubject String subject, @NotificationMessage String message) {
        // ...
    }

    @NotificationUnsubscribeConfirmationMapping
    public void handleUnsubscribeMessage(NotificationStatus status) {
        //e.g. the client has been unsubscribed and we want to "re-subscribe"
        status.confirmSubscription();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-4"><a class="anchor" href="#configuration-4"></a><a class="link" href="#configuration-4">7.4. Configuration</a></h3>
<div class="paragraph">
<p>The Spring Boot Starter for SNS provides the following configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.sns.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the SNS integration.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.sns.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures endpoint used by <code>SnsClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://localhost:4566" class="bare">localhost:4566</a></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.sns.region</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures region used by <code>SnsClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eu-west-1</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="iam-permissions-4"><a class="anchor" href="#iam-permissions-4"></a><a class="link" href="#iam-permissions-4">7.5. IAM Permissions</a></h3>
<div class="paragraph">
<p>Following IAM permissions are required by Spring Cloud AWS:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 66.6666%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">To publish notification to topic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sns:Publish</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">To publish notification you will also need</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sns:ListTopics</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">To use Annotation-driven HTTP notification endpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sns:ConfirmSubscription</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">For resolving topic name to ARN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sns:CreateTopic</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Sample IAM policy granting access to SNS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "sns:Publish",
                "sns:ConfirmSubscription"
            ],
            "Resource": "yourArn"
        },
        {
            "Effect": "Allow",
            "Action": "sns:ListTopics",
            "Resource": "*"
        },
        {
        "Effect": "Allow",
        "Action": "sns:CreateTopic",
        "Resource": "*"
        }
    ]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sqs-support"><a class="anchor" href="#sqs-support"></a><a class="link" href="#sqs-support">8. SQS Support</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Amazon <code>Simple Queue Service</code> is a messaging service that provides point-to-point communication with queues.
Spring Cloud AWS SQS integration offers support to receive and send messages using common <code>Spring</code> abstractions such as <code>@SqsListener</code>, <code>MessageListenerContainer</code> and <code>MessageListenerContainerFactory</code>.</p>
</div>
<div class="paragraph">
<p>Compared to JMS or other message services Amazon SQS has limitations that should be taken into consideration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Amazon SQS allows only <code>String</code> payloads, so any <code>Object</code> must be transformed into a String representation.
Spring Cloud AWS has dedicated support to transfer Java objects with Amazon SQS messages by converting them to JSON.</p>
</li>
<li>
<p>Amazon SQS has a maximum message size of 256kb per message, so bigger messages will fail to be sent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A Spring Boot starter is provided to auto-configure SQS integration beans.
Maven coordinates, using <a href="#bill-of-materials">Spring Cloud AWS BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-aws-starter-sqs&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="sample-listener-application"><a class="anchor" href="#sample-listener-application"></a><a class="link" href="#sample-listener-application">8.1. Sample Listener Application</a></h3>
<div class="paragraph">
<p>Below is a minimal sample application leveraging auto-configuration from <code>Spring Boot</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SpringBootApplication
public class SqsApplication {

    public static void main(String[] args) {
        SpringApplication.run(SqsApplication.class, args);
    }

    @SqsListener("myQueue")
    public void listen(String message) {
        System.out.println(message);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Without Spring Boot, it&#8217;s necessary to import the <code>SqsBootstrapConfiguration</code> class in a <code>@Configuration</code>, as well as declare a <code>SqsMessageListenerContainerFactory</code> bean.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Listener {

    @SqsListener("myQueue")
    public void listen(String message) {
        System.out.println(message);
    }

}

@Import(SqsBootstrapConfiguration.class)
@Configuration
public class SQSConfiguration {

    @Bean
    public SqsMessageListenerContainerFactory&lt;Object&gt; defaultSqsListenerContainerFactory() {
        return SqsMessageListenerContainerFactory
            .builder()
            .sqsAsyncClient(sqsAsyncClient())
            .build();
    }

    @Bean
    public SqsAsyncClient sqsAsyncClient() {
        return SqsAsyncClient.builder().build();
    }

    @Bean
    public Listener listener() {
        return new Listener();
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sending-messages"><a class="anchor" href="#sending-messages"></a><a class="link" href="#sending-messages">8.2. Sending Messages</a></h3>
<div class="paragraph">
<p>Spring Cloud AWS SQS autoconfigures a <code>SqsAsyncClient</code> bean that can be used for sending messages.
Note that the payload has to be converted to a JSON String to be sent.
A <code>SqsTemplate</code> should be included in a future milestone simplifying this process.</p>
</div>
<div class="paragraph">
<p>Currently, a lightweight producer abstraction can be created to facilitate sending messages, such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Component
public class SqsSampleProducer {

    private final SqsAsyncClient sqsAsyncClient;

    private final ObjectMapper objectMapper;

    public SqsSampleProducer(SqsAsyncClient sqsAsyncClient, ObjectMapper objectMapper) {
        this.sqsAsyncClient = sqsAsyncClient;
        this.objectMapper = objectMapper;
    }

    public CompletableFuture&lt;Void&gt; sendToUrl(String queueUrl, Object payload) {
        return this.sqsAsyncClient.sendMessage(request -&gt; request.messageBody(getMessageBodyAsJson(payload)).queueUrl(queueUrl))
                .thenRun(() -&gt; {});
    }

    public CompletableFuture&lt;Void&gt; send(String queueName, Object payload) {
        return this.sqsAsyncClient.getQueueUrl(request -&gt; request.queueName(queueName))
                .thenApply(GetQueueUrlResponse::queueUrl)
                .thenCompose(queueUrl -&gt; sendToUrl(queueUrl, payload));
    }

    private String getMessageBodyAsJson(Object payload) {
        try {
            return objectMapper.writeValueAsString(payload);
        }
        catch (JsonProcessingException e) {
            throw new IllegalArgumentException("Error converting payload: " + payload, e);
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modifications can be made to enable adding other attributes such as <code>MessageGroupId</code>, <code>MessageAttributes</code> and <code>MessageDeduplicationId</code>.</p>
</div>
<div class="paragraph">
<p>It can then be autowired and used such as:</p>
</div>
<div class="paragraph">
<p><code>sampleProducer.send(queueName, new MyPojo("My value", "My Other Value")).join();</code></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>join()</code> method blocks the thread and throws any error from the operation. If a <code>CompletableFuture</code> chain is being used, simply return the value instead.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="receiving-messages"><a class="anchor" href="#receiving-messages"></a><a class="link" href="#receiving-messages">8.3. Receiving Messages</a></h3>
<div class="paragraph">
<p>The framework offers the following options to receive messages from a queue.</p>
</div>
<div class="sect3">
<h4 id="message-listeners"><a class="anchor" href="#message-listeners"></a><a class="link" href="#message-listeners">8.3.1. Message Listeners</a></h4>
<div class="paragraph">
<p>To receive messages in a manually created container, a <code>MessageListener</code> or <code>AsyncMessageListener</code> must be provided.
Both interfaces come with <code>single message</code> and a <code>batch</code> methods.
These are functional interfaces and a lambda or method reference can be provided for the single message methods.</p>
</div>
<div class="paragraph">
<p>Single message / batch modes and message payload conversion can be configured via <code>ContainerOptions</code>.
See <a href="#message-conversion-and-payload-deserialization">Message Conversion and Payload Deserialization</a> for more information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@FunctionalInterface
public interface MessageListener&lt;T&gt; {

    void onMessage(Message&lt;T&gt; message);

    default void onMessage(Collection&lt;Message&lt;T&gt;&gt; messages) {
        throw new UnsupportedOperationException("Batch not implemented by this MessageListener");
    }

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@FunctionalInterface
public interface AsyncMessageListener&lt;T&gt; {

    CompletableFuture&lt;Void&gt; onMessage(Message&lt;T&gt; message);

    default CompletableFuture&lt;Void&gt; onMessage(Collection&lt;Message&lt;T&gt;&gt; messages) {
        return CompletableFutures
                .failedFuture(new UnsupportedOperationException("Batch not implemented by this AsyncMessageListener"));
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sqsmessagelistenercontainer"><a class="anchor" href="#sqsmessagelistenercontainer"></a><a class="link" href="#sqsmessagelistenercontainer">8.3.2. SqsMessageListenerContainer</a></h4>
<div class="paragraph">
<p>The <code>MessageListenerContainer</code> manages the entire messages` lifecycle, from polling, to processing, to acknowledging.</p>
</div>
<div class="paragraph">
<p>It can be instantiated directly, using a <code>SqsMessageListenerContainerFactory</code>, or using <code>@SqsListener</code> annotations.
If declared as a <code>@Bean</code>, the <code>Spring</code> context will manage its lifecycle, starting the container on application startup and stopping it on application shutdown.
See <a href="#container-lifecycle">Container Lifecycle</a> for more information.</p>
</div>
<div class="paragraph">
<p>It implements the <code>MessageListenerContainer</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface MessageListenerContainer&lt;T&gt; extends SmartLifecycle {

    String getId();

    void setId(String id);

    void setMessageListener(MessageListener&lt;T&gt; messageListener);

    void setAsyncMessageListener(AsyncMessageListener&lt;T&gt; asyncMessageListener);

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The generic parameter <code>&lt;T&gt;</code> stands for the <code>payload type</code> of messages to be consumed by this container.
This allows ensuring at compile-time that all components used with the container are for the same type.
If more than one payload type is to be used by the same container or factory, simply type it as <code>Object</code>.
This type is not considered for payload conversion.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A container can be instantiated in a familiar Spring way in a <code>@Configuration</code> annotated class.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
MessageListenerContainer&lt;Object&gt; listenerContainer(SqsAsyncClient sqsAsyncClient) {
    SqsMessageListenerContainer&lt;Object&gt; container = new SqsMessageListenerContainer&lt;&gt;(sqsAsyncClient);
    container.setMessageListener(System.out::println);
    container.setQueueNames("myTestQueue");
    return container;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This framework also provides a convenient <code>Builder</code> that allows a different approach, such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
MessageListenerContainer&lt;Object&gt; listenerContainer(SqsAsyncClient sqsAsyncClient) {
    return SqsMessageListenerContainer
            .builder()
            .sqsAsyncClient(sqsAsyncClient)
            .messageListener(System.out::println)
            .queueNames("myTestQueue")
            .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The container&#8217;s lifecycle can also be managed manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">void myMethod(SqsAsyncClient sqsAsyncClient) {
    SqsMessageListenerContainer&lt;Object&gt; container = SqsMessageListenerContainer
            .builder()
            .sqsAsyncClient(sqsAsyncClient)
            .messageListener(System.out::println)
            .queueNames("myTestQueue")
            .build();
    container.start();
    container.stop();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sqsmessagelistenercontainerfactory"><a class="anchor" href="#sqsmessagelistenercontainerfactory"></a><a class="link" href="#sqsmessagelistenercontainerfactory">8.3.3. SqsMessageListenerContainerFactory</a></h4>
<div class="paragraph">
<p>A <code>MessageListenerContainerFactory</code> can be used to create <code>MessageListenerContainer</code> instances, both directly or through <code>@SqsListener</code> annotations.</p>
</div>
<div class="paragraph">
<p>It can be created in a familiar <code>Spring</code> way, such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
SqsMessageListenerContainerFactory&lt;Object&gt; defaultSqsListenerContainerFactory(SqsAsyncClient sqsAsyncClient) {
    SqsMessageListenerContainerFactory&lt;Object&gt; factory = new SqsMessageListenerContainerFactory&lt;&gt;();
    factory.setSqsAsyncClient(sqsAsyncClient);
    return factory;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or through the <code>Builder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
SqsMessageListenerContainerFactory&lt;Object&gt; defaultSqsListenerContainerFactory(SqsAsyncClient sqsAsyncClient) {
    return SqsMessageListenerContainerFactory
            .builder()
            .sqsAsyncClient(sqsAsyncClient)
            .build();
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Using this method for setting the <code>SqsAsyncClient</code> instance in the factory, all containers created by this factory will share the same <code>SqsAsyncClient</code> instance.
For high-throughput applications, a <code>Supplier&lt;SqsAsyncClient&gt;</code> can be provided instead through the factory&#8217;s <code>setSqsAsyncClientSupplier</code> or the builder&#8217;s <code>sqsAsyncSupplier</code> methods.
In this case each container will receive a <code>SqsAsyncClient</code> instance.
Alternatively, a single <code>SqsAsyncClient</code> instance can be configured for higher throughput. See the AWS documentation for more information on tradeoffs of each approach.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The factory can also be used to create a container directly, such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
MessageListenerContainer&lt;Object&gt; myListenerContainer(SqsAsyncClient sqsAsyncClient) {
    return SqsMessageListenerContainerFactory
            .builder()
            .sqsAsyncClient(sqsAsyncClient)
            .messageListener(System.out::println)
            .build()
            .createContainer("myQueue");
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sqslistener-annotation"><a class="anchor" href="#sqslistener-annotation"></a><a class="link" href="#sqslistener-annotation">8.3.4. @SqsListener Annotation</a></h4>
<div class="paragraph">
<p>The simplest way to consume <code>SQS</code> messages is by annotating a method in a <code>@Component</code> class with the <code>@SqsListener</code> annotation.
The framework will then create the <code>MessageListenerContainer</code> and set a <code>MessagingMessageListenerAdapter</code> to invoke the method when a message is received.</p>
</div>
<div class="paragraph">
<p>When using <code>Spring Boot</code> with <code>auto-configuration</code>, no configuration is necessary.</p>
</div>
<div class="paragraph">
<p>Most attributes on the annotation can be resolved from SpEL <code>(#{&#8230;&#8203;})</code> or property placeholders <code>(${&#8230;&#8203;})</code>.</p>
</div>
<div class="sect4">
<h5 id="queue-names"><a class="anchor" href="#queue-names"></a><a class="link" href="#queue-names">Queue Names</a></h5>
<div class="paragraph">
<p>One or more queues can be specified in the annotation through the <code>queueNames</code> or <code>value</code> properties - there&#8217;s no distinction between the two properties.</p>
</div>
<div class="paragraph">
<p>Instead of queue names, queue urls can also be provided.
Using urls instead of queue names can result in slightly faster startup times since it prevents the framework from looking up the queue url when the containers start.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SqsListener({"${my.queue.url}", "myOtherQueue"})
public void listenTwoQueues(String message) {
    System.out.println(message);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any number of <code>@SqsListener</code> annotations can be used in a bean class, and each annotated method will be handled by a separate <code>MessageListenerContainer</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Queues declared in the same annotation will share the container, though each will have separate throughput and acknowledgement controls.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="specifying-a-messagelistenercontainerfactory"><a class="anchor" href="#specifying-a-messagelistenercontainerfactory"></a><a class="link" href="#specifying-a-messagelistenercontainerfactory">Specifying a MessageListenerContainerFactory</a></h5>
<div class="paragraph">
<p>A <code>MessageListenerContainerFactory</code> can be specified through the <code>factory</code> property.
Such factory will then be used to create the container for the annotated method.</p>
</div>
<div class="paragraph">
<p>If not specified, a factory with the <code>defaultSqsListenerContainerFactory</code> name will be looked up.
For changing this default name, see <a href="#global-configuration-for-sqslisteners">Global Configuration for @SqsListeners</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SqsListener(queueNames = "myQueue", factory = "myFactory")
public void listen(String message) {
    System.out.println(message);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using a <code>Spring Boot</code> application with <code>auto-configuration</code>, a default factory is provided if there are no other factory beans declared in the context.</p>
</div>
</div>
<div class="sect4">
<h5 id="other-annotation-properties"><a class="anchor" href="#other-annotation-properties"></a><a class="link" href="#other-annotation-properties">Other Annotation Properties</a></h5>
<div class="paragraph">
<p>The following properties can be specified in the <code>@SqsListener</code> annotation.
Such properties override the equivalent <code>ContainerOptions</code> for the resulting <code>MessageListenerContainer</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code> - Specify the resulting container&#8217;s id.
This can be used for fetching the container from the <code>MessageListenerContainerRegistry</code>, and is used by the container and its components for general logging and thread naming.</p>
</li>
<li>
<p><code>maxInflightMessagesPerQueue</code> - Set the maximum number of messages that can be <code>inflight</code> at any given moment.
See <a href="#message-processing-throughput">Message Processing Throughput</a> for more information.</p>
</li>
<li>
<p><code>pollTimeoutSeconds</code> - Set the maximum time to wait before a poll returns from SQS.
Note that if there are messages available the call may return earlier than this setting.</p>
</li>
<li>
<p><code>messageVisibilitySeconds</code> - Set the minimum visibility for the messages retrieved in a poll.
Note that for <code>FIFO</code> single message listener methods, this visibility is applied to the whole batch before each message is sent to the listener.
See <a href="#fifo-support">FIFO Support</a> for more information.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="listener-method-arguments"><a class="anchor" href="#listener-method-arguments"></a><a class="link" href="#listener-method-arguments">Listener Method Arguments</a></h5>
<div class="paragraph">
<p>A number of possible argument types are allowed in the listener method&#8217;s signature.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>MyPojo</code> - POJO types are automatically deserialized from JSON.</p>
</li>
<li>
<p><code>Message&lt;MyPojo&gt;</code> - Provides a <code>Message&lt;MyPojo&gt;</code> instance with the deserialized payload and <code>MessageHeaders</code>.</p>
</li>
<li>
<p><code>List&lt;MyPojo&gt;</code> - Enables batch mode and receives the batch that was polled from SQS.</p>
</li>
<li>
<p><code>List&lt;Message&lt;MyPojo&gt;&gt;</code> - Enables batch mode and receives the batch that was polled from SQS along with headers.</p>
</li>
<li>
<p><code>@Header(String headerName)</code> - provides the specified header.</p>
</li>
<li>
<p><code>@Headers</code> - provides the <code>MessageHeaders</code> or a <code>Map&lt;String, Object&gt;</code></p>
</li>
<li>
<p><code>Acknowledgement</code> - provides the <code>.acknowledge()</code> method that can be used to manually acknowledge the message.
AcknowledgementMode must be set to <code>MANUAL</code> (see <a href="#acknowledging-messages">Acknowledging Messages</a>)</p>
</li>
<li>
<p><code>AsyncAcknowledgement</code> - provides the <code>.acknowledgeAsync()</code> method that can be used to manually acknowledge the message.
AcknowledgementMode must be set to <code>MANUAL</code> (see <a href="#acknowledging-messages">Acknowledging Messages</a>)</p>
</li>
<li>
<p><code>Visibility</code> - provides the <code>changeTo()</code> method that enables changing the message&#8217;s visibility to the provided value.</p>
</li>
<li>
<p><code>QueueAttributes</code> - provides queue attributes for the queue that received the message.
See <a href="#retrieving-attributes-from-sqs">Retrieving Attributes from SQS</a> for how to specify the queue attributes that will be fetched from <code>SQS</code></p>
</li>
<li>
<p><code>software.amazon.awssdk.services.sqs.model.Message</code> - provides the original <code>Message</code> from <code>SQS</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here&#8217;s a sample with many arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SqsListener("${my-queue-name}")
public void listen(Message&lt;MyPojo&gt; message, MyPojo pojo, MessageHeaders headers, Acknowledgement ack, Visibility visibility, QueueAttributes queueAttributes, AsyncAcknowledgement asyncAck, software.amazon.awssdk.services.sqs.model.Message originalMessage) {
    Assert.notNull(message);
    Assert.notNull(pojo);
    Assert.notNull(headers);
    Assert.notNull(ack);
    Assert.notNull(asyncAck);
    Assert.notNull(visibility);
    Assert.notNull(queueAttributes);
    Assert.notNull(originalMessage);
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Currently, batch listeners only support <code>List&lt;MyPojo&gt;</code> and <code>List&lt;Message&lt;MyPojo&gt;&gt;</code> method arguments.
Other arguments can be found as headers in the <code>Message&lt;MyPojo&gt;</code> instances and can be extracted through the <code>getHeader</code> method.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="batch-processing"><a class="anchor" href="#batch-processing"></a><a class="link" href="#batch-processing">8.3.5. Batch Processing</a></h4>
<div class="paragraph">
<p>All message processing interfaces have both <code>single message</code> and <code>batch</code> methods.
This means the same set of components can be used to process both single and batch methods, and can share logic where applicable.</p>
</div>
<div class="paragraph">
<p>When batch mode is enabled, the framework will serve the entire result of a poll to the listener.</p>
</div>
<div class="paragraph">
<p>To enable batch processing using <code>@SqsListener</code>, declare a <code>List&lt;MyPojo&gt;</code> or <code>List&lt;Message&lt;MyPojo&gt;&gt;</code> method argument in the listener method.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Currently, when declaring batch mode this way, no other arguments can be added to the method signature.
If any metadata is required, the <code>List&lt;Message&lt;MyPojo&gt;&gt;</code> variant should be used, then the headers can be checked to retrieve such information.
The <code>SqsHeaders.SQS_ACKNOWLEDGMENT_CALLBACK_HEADER</code> will contain the <code>AcknowldgementCallback</code> you can use to manually acknowledge the messages in <code>AcknowledgementMode.MANUAL</code>.
If acknowledgement batching is being used, acknowledgements will be batched instead of executing immediately.
See <a href="#acknowledging-messages">Acknowledging Messages</a> for more information on <code>Acknowledging messages</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To configure a batch processing at factory or container level, set <code>MessageDeliveryStrategy.BATCH</code> in the <code>ContainerOptions</code>, in the factory or container.
This will affect manually created containers.
Containers created from <code>@SqsListener</code> annotations will override this setting with whether they contain a <code>List&lt;Pojoj&gt;</code> or <code>List&lt;Message&lt;Pojo&gt;&gt;</code> argument.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The same factory can be used to create both <code>single message</code> and <code>batch</code> containers for <code>@SqsListener</code> methods.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In case the same factory is shared by both delivery methods, any supplied <code>ErrorHandler</code>, <code>MessageInterceptor</code> or <code>MessageListener</code> should implement the proper methods.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If batch mode is enabled, make sure all components being used have the necessary <code>batch</code> methods implemented, otherwise an error may occur.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="container-options"><a class="anchor" href="#container-options"></a><a class="link" href="#container-options">8.3.6. Container Options</a></h4>
<div class="paragraph">
<p>Each <code>MessageListenerContainer</code> can have a different set of options.
<code>MessageListenerContainerFactory</code> instances have a <code>ContainerOptions.Builder</code> instance property that is used as a template for the containers it creates.</p>
</div>
<div class="paragraph">
<p>Both factory and container offer a <code>configure</code> method that can be used to change the options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
SqsMessageListenerContainerFactory&lt;Object&gt; defaultSqsListenerContainerFactory(SqsAsyncClient sqsAsyncClient) {
    return SqsMessageListenerContainerFactory
            .builder()
            .configure(options -&gt; options
                    .messagesPerPoll(5)
                    .pollTimeout(Duration.ofSeconds(10)))
            .sqsAsyncClient(sqsAsyncClient)
            .build();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
MessageListenerContainer&lt;Object&gt; listenerContainer(SqsAsyncClient sqsAsyncClient) {
    return SqsMessageListenerContainer
            .builder()
            .configure(options -&gt; options
                    .messagesPerPoll(5)
                    .pollTimeout(Duration.ofSeconds(10)))
            .sqsAsyncClient(sqsAsyncClient)
            .messageListener(System.out::println)
            .queueNames("myTestQueue")
            .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ContainerOptions</code> instance is immutable and can be retrieved via the <code>container.getContainerOptions()</code> method.
If more complex configurations are necessary, the <code>toBuilder</code> and <code>fromBuilder</code> methods provide ways to create a new copy of the options, and then set it back to the factory or container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">void myMethod(MessageListenerContainer&lt;Object&gt; container) {
    ContainerOptions.Builder modifiedOptions = container.getContainerOptions()
            .toBuilder()
            .pollTimeout(Duration.ofSeconds(5))
            .shutdownTimeout(Duration.ofSeconds(20));
    container.configure(options -&gt; options.fromBuilder(modifiedOptions));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A copy of the options can also be created with <code>containerOptions.createCopy()</code> or <code>containerOptionsBuilder.createCopy()</code>.</p>
</div>
<div class="sect4">
<h5 id="using-auto-configuration"><a class="anchor" href="#using-auto-configuration"></a><a class="link" href="#using-auto-configuration">Using Auto-Configuration</a></h5>
<div class="paragraph">
<p>The Spring Boot Starter for SQS provides the following auto-configuration properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.sqs.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the SQS integration.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.sqs.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures endpoint used by <code>SqsAsyncClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://localhost:4566" class="bare">localhost:4566</a></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.sqs.region</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures region used by <code>SqsAsyncClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eu-west-1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#maxinflightmessagesperqueue"><code>spring.cloud.aws.sqs.listener.max-inflight-messages-per-queue</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of inflight messages per queue.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#maxmessagesperpoll"><code>spring.cloud.aws.sqs.listener.max-messages-per-poll</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of messages to be received per poll.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#polltimeout"><code>spring.cloud.aws.sqs.listener.poll-timeout</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum amount of time to wait for messages in a poll.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 seconds</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="containeroptions-descriptions"><a class="anchor" href="#containeroptions-descriptions"></a><a class="link" href="#containeroptions-descriptions">ContainerOptions Descriptions</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 27.6595%;">
<col style="width: 19.1489%;">
<col style="width: 19.1489%;">
<col style="width: 34.0427%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Range</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#maxinflightmessagesperqueue">maxInflightMessagesPerQueue</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 - <code>Integer.MAX_VALUE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of messages from each queue that can be processed simultaneously in this container.
This number will be used for defining the thread pool size for the container following (maxInflightMessagesPerQueue * number of queues).
For batching acknowledgements a message is considered as no longer inflight when it&#8217;s handed to the acknowledgement queue.
See <a href="#acknowledging-messages">Acknowledging Messages</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#maxmessagesperpoll">maxMessagesPerPoll</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 - 10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of messages that will be received by a poll to a SQS queue in this container.
See AWS documentation for more information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#polltimeout">pollTimeout</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 - 10 seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum duration for a poll to a SQS queue before returning empty.
Longer polls decrease the chance of empty polls when messages are available.
See AWS documentation for more information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#permitacquiretimeout">permitAcquireTimeout</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 - 10 seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum time the framework will wait for permits to be available for a queue before attempting the next poll.
After that period, the framework will try to perform a partial acquire with the available permits, resulting in a poll for less than <code>maxMessagesPerPoll</code> messages, unless otherwise configured.
See <a href="#message-processing-throughput">Message Processing Throughput</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shutdownTimeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 - undefined</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 seconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount of time the container will wait for a queue to complete its operations before attempting to forcefully shutdown.
See <a href="#container-lifecycle">Container Lifecycle</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>backPressureMode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AUTO</code>, <code>ALWAYS_POLL_MAX_MESSAGES</code>, <code>FIXED_HIGH_THROUGHPUT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AUTO</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the backpressure strategy to be used by the container.
See <a href="#configuring-backpressuremode">Configuring BackPressureMode</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messageDeliveryStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SINGLE_MESSAGE</code>, <code>BATCH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SINGLE_MESSAGE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures whether this container will use <code>single message</code> or <code>batch</code> listeners.
This value is overriden by <code>@SqsListener</code> depending on whether the listener method contains a <code>List</code> argument.
See <a href="#batch-processing">Batch Processing</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>queueAttributeNames</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Collection&lt;QueueAttributeName&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the <code>QueueAttributes</code> that will be retrieved from SQS when a container starts.
See <a href="#retrieving-attributes-from-sqs">Retrieving Attributes from SQS</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messageAttributeNames</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Collection&lt;String&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ALL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the <code>MessageAttributes</code> that will be retrieved from SQS for each message.
See <a href="#retrieving-attributes-from-sqs">Retrieving Attributes from SQS</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messageSystemAttributeNames</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Collection&lt;String&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ALL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the <code>MessageSystemAttribute</code> that will be retrieved from SQS for each message.
See <a href="#retrieving-attributes-from-sqs">Retrieving Attributes from SQS</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messageConverter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MessagingMessageConverter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SqsMessagingMessageConverter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the <code>MessagingMessageConverter</code> that will be used to convert SQS messages into Spring Messaging Messages.
See <a href="#message-conversion-and-payload-deserialization">Message Conversion and Payload Deserialization</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>acknowledgementMode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ON_SUCCESS</code>, <code>ALWAYS</code>, <code>MANUAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ON_SUCCESS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the processing outcomes that will trigger automatic acknowledging of messages.
See <a href="#acknowledging-messages">Acknowledging Messages</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>acknowledgementInterval</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 - undefined</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1 second</code> for <code>Standard SQS</code>, <code>Duration.ZERO</code> for <code>FIFO SQS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the interval between acknowledges for batching.
Set to <code>Duration.ZERO</code> along with <code>acknowledgementThreshold</code> to zero to enable <code>immediate acknowledgement</code>
See <a href="#acknowledging-messages">Acknowledging Messages</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>acknowledgementThreshold</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 - undefined</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10</code> for <code>Standard SQS</code>, <code>0</code> for <code>FIFO SQS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the minimal amount of messages in the acknowledgement queue to trigger acknowledgement of a batch.
Set to zero along with <code>acknowledgementInterval</code> to <code>Duration.ZERO</code> to enable <code>immediate acknowledgement</code>.
See <a href="#acknowledging-messages">Acknowledging Messages</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>acknowledgementOrdering</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PARALLEL</code>, <code>ORDERED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PARALLEL</code> for <code>Standard SQS</code> and <code>FIFO</code> queues with immediate acknowledgement, <code>ORDERED</code> for <code>FIFO</code> queues with acknowledgement batching enabled.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the order acknowledgements should be made.
Fifo queues can be acknowledged in parallel for immediate acknowledgement since the next message for a message group will only start being processed after the previous one has been acknowledged.
See <a href="#acknowledging-messages">Acknowledging Messages</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>containerComponentsTaskExecutor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TaskExecutor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides a <code>TaskExecutor</code> instance to be used by the <code>MessageListenerContainer</code> internal components.
See <a href="#providing-a-taskexecutor">Providing a TaskExecutor</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messageVisibility</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Duration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the message visibility duration for messages polled in this container.
For <code>FIFO</code> queues, visibility is extended for all messages in a message group before each message is processed.
See <a href="#fifo-support">FIFO Support</a>.
Otherwise, visibility is specified once when polling SQS.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>queueNotFoundStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FAIL</code>, <code>CREATE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CREATE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures the behavior when a queue is not found at container startup.
See <a href="#container-lifecycle">Container Lifecycle</a>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="retrieving-attributes-from-sqs"><a class="anchor" href="#retrieving-attributes-from-sqs"></a><a class="link" href="#retrieving-attributes-from-sqs">8.3.7. Retrieving Attributes from SQS</a></h4>
<div class="paragraph">
<p><code>QueueAttributes</code>, <code>MessageAttributes</code> and <code>MessageSystemAttributes</code> can be retrieved from SQS.
These can be configured using the <code>ContainerOptions</code> <code>queueAttributeNames</code>, <code>messageAttributeNames</code> and <code>messageSystemAttributeNames</code> methods.</p>
</div>
<div class="paragraph">
<p><code>QueueAttributes</code> for a queue are retrieved when containers start, and can be looked up by adding the <code>QueueAttributes</code> method parameter in a <code>@SqsListener</code> method, or by getting the <code>SqsHeaders.SQS_QUEUE_ATTRIBUTES_HEADER</code> header.</p>
</div>
<div class="paragraph">
<p><code>MessageAttributes</code> and <code>MessageSystemAttributes</code> are retrieved with each message, and are mapped to message headers.
Those can be retrieved with <code>@Header</code> parameters, or directly in the <code>Message</code>.
The message headers are prefixed with <code>SqsHeaders.SQS_MA_HEADER_PREFIX</code> ("Sqs_MA_") for message attributes and
<code>SqsHeaders.SQS_MSA_HEADER_PREFIX</code> ("Sqs_MSA_") for message system attributes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, no <code>QueueAttributes</code> and <code>ALL</code> <code>MessageAttributes</code> and <code>MessageSystemAttributes</code> are retrieved.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="container-lifecycle"><a class="anchor" href="#container-lifecycle"></a><a class="link" href="#container-lifecycle">8.3.8. Container Lifecycle</a></h4>
<div class="paragraph">
<p>The <code>MessageListenerContainer</code> interface extends <code>SmartLifecycle</code>, which provides methods to control the container&#8217;s lifecycle.</p>
</div>
<div class="paragraph">
<p>Containers created from <code>@SqsListener</code> annotations are registered in a <code>MessageListenerContainerRegistry</code> bean that is registered by the framework.
The containers themselves are not Spring-managed beans, and the registry is responsible for managing these containers` lifecycle in application startup and shutdown.</p>
</div>
<div class="paragraph">
<p>At startup, the containers will make requests to <code>SQS</code> to retrieve the queues` urls for the provided queue names, and for retrieving <code>QueueAttributes</code> if so configured.
Providing queue urls instead of names and not requesting queue attributes can result in slightly better startup times since there&#8217;s no need for such requests.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If retrieving the queue url fails due to the queue not existing, the framework can be configured to either create the queue or fail.
If a URL is provided instead of a queue name the framework will not make this request at startup, and thus if the queue does not exist it will fail at runtime.
This configuration is available in <code>ContainerOptions</code> <code>queueNotFoundStrategy.</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At shutdown, by default containers will wait for all polling, processing and acknowledging operations to finish, up to <code>ContainerOptions.getShutdownTimeout()</code>.
After this period, operations will be canceled and the container will attempt to forcefully shutdown.</p>
</div>
<div class="sect4">
<h5 id="containers-as-spring-beans"><a class="anchor" href="#containers-as-spring-beans"></a><a class="link" href="#containers-as-spring-beans">Containers as Spring Beans</a></h5>
<div class="paragraph">
<p>Manually created containers can be registered as beans, e.g. by declaring a <code>@Bean</code> in a <code>@Configuration</code> annotated class.
In these cases the containers lifecycle will be managed by the <code>Spring</code> context at application startup and shutdown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
MessageListenerContainer&lt;Object&gt; listenerContainer(SqsAsyncClient sqsAsyncClient) {
    return SqsMessageListenerContainer
            .builder()
            .sqsAsyncClient(sqsAsyncClient)
            .messageListener(System.out::println)
            .queueNames("myTestQueue")
            .build();
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="retrieving-containers-from-the-registry"><a class="anchor" href="#retrieving-containers-from-the-registry"></a><a class="link" href="#retrieving-containers-from-the-registry">Retrieving Containers from the Registry</a></h5>
<div class="paragraph">
<p>Containers can be retrieved by fetching the <code>MessageListenerContainer</code> bean from the container and using the <code>getListenerContainers</code> and <code>getContainerById</code> methods.
Then lifecycle methods can be used to start and stop instances.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Autowired
MessageListenerContainerRegistry registry;

public void myLifecycleMethod() {
    MessageListenerContainer container = registry.getContainerById("myId");
    container.stop();
    container.start();
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="lifecycle-execution"><a class="anchor" href="#lifecycle-execution"></a><a class="link" href="#lifecycle-execution">Lifecycle Execution</a></h5>
<div class="paragraph">
<p>By default, all lifecycle actions performed by the <code>MessageListenerContainerRegistry</code> and internally by the <code>MessageListenerContainer</code> instances are executed in parallel.</p>
</div>
<div class="paragraph">
<p>This behavior can be disabled by setting <code>LifecycleHandler.get().setParallelLifecycle(false)</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring-managed <code>MessageListenerContainer</code> beans' lifecycle actions are always performed sequentially.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="fifo-support"><a class="anchor" href="#fifo-support"></a><a class="link" href="#fifo-support">8.3.9. FIFO Support</a></h4>
<div class="paragraph">
<p><code>FIFO</code> SQS queues are fully supported for receiving messages - queues with names that ends in <code>.fifo</code> will automatically be setup as such.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Messages are polled with a <code>receiveRequestAttemptId</code>, and the received batch of messages is split according to the message`s <code>MessageGroupId</code>.</p>
</li>
<li>
<p>Each message from a given group will then be processed in order, while each group is processed in parallel.</p>
</li>
<li>
<p>If processing fails for a message, the following messages from the same message group are discarded so they will be served again after their <code>message visibility</code>
expires.</p>
</li>
<li>
<p>Messages which were already successfully processed and acknowledged will not be served again.</p>
</li>
<li>
<p>If a <code>batch</code> listener is used, each message group from a poll will be served as a batch to the listener method.</p>
</li>
<li>
<p><code>FIFO</code> queues also have different defaults for acknowledging messages, see <a href="#acknowledgement-defaults">Acknowledgement Defaults</a> for more information.</p>
</li>
<li>
<p>If a <code>message visibility</code> is set through <code>@SqsListener</code> or <code>ContainerOptions</code>, visibility will be extended for all messages in the message group before each message is processed.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
A <code>MessageListenerContainer</code> can either have only <code>Standard</code> queues or <code>FIFO</code> queues - not both.
This is valid both for manually created containers and <code>@SqsListener</code> annotated methods.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="message-interceptor"><a class="anchor" href="#message-interceptor"></a><a class="link" href="#message-interceptor">8.4. Message Interceptor</a></h3>
<div class="paragraph">
<p>The framework offers the <code>MessageInterceptor</code> and the <code>AsyncMessageInterceptor</code> interfaces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface MessageInterceptor&lt;T&gt; {

    default Message&lt;T&gt; intercept(Message&lt;T&gt; message) {
        return message;
    }

    default Collection&lt;Message&lt;T&gt;&gt; intercept(Collection&lt;Message&lt;T&gt;&gt; messages) {
        return messages;
    }

    default void afterProcessing(Message&lt;T&gt; message, Throwable t) {
    }

    default void afterProcessing(Collection&lt;Message&lt;T&gt;&gt; messages, Throwable t) {
    }

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface AsyncMessageInterceptor&lt;T&gt; {

    default CompletableFuture&lt;Message&lt;T&gt;&gt; intercept(Message&lt;T&gt; message) {
        return CompletableFuture.completedFuture(message);
    }

    default CompletableFuture&lt;Collection&lt;Message&lt;T&gt;&gt;&gt; intercept(Collection&lt;Message&lt;T&gt;&gt; messages) {
        return CompletableFuture.completedFuture(messages);
    }

    default CompletableFuture&lt;Void&gt; afterProcessing(Message&lt;T&gt; message, Throwable t) {
        return CompletableFuture.completedFuture(null);
    }

    default CompletableFuture&lt;Void&gt; afterProcessing(Collection&lt;Message&lt;T&gt;&gt; messages, Throwable t) {
        return CompletableFuture.completedFuture(null);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the auto-configured factory, simply declare a <code>@Bean</code> and the interceptor will be set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public MessageInterceptor&lt;Object&gt; messageInterceptor() {
    return new MessageInterceptor&lt;Object&gt;() {
            @Override
            public Message&lt;Object&gt; intercept(Message&lt;Object&gt; message) {
                return MessageBuilder
                    .fromMessage(message)
                    .setHeader("newHeader", "newValue")
                    .build();
            }
        };
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, implementations can be set in the <code>MessageListenerContainerFactory</code> or directly in the <code>MessageListenerContainer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public SqsMessageListenerContainerFactory&lt;Object&gt; defaultSqsListenerContainerFactory() {
    return SqsMessageListenerContainerFactory
        .builder()
        .sqsAsyncClientSupplier(BaseSqsIntegrationTest::createAsyncClient)
        .messageInterceptor(new MessageInterceptor&lt;Object&gt;() {
            @Override
            public Message&lt;Object&gt; intercept(Message&lt;Object&gt; message) {
                return MessageBuilder
                    .fromMessage(message)
                    .setHeader("newHeader", "newValue")
                    .build();
            }
        })
        .build();
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Multiple interceptors can be added to the same factory or container.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>intercept</code> methods are executed <code>before</code> a message is processed, and a different message can be returned.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In case a different message is returned, it&#8217;s important to add the <code>SqsHeaders.SQS_RECEIPT_HANDLE_HEADER</code> with the value of the original handler so the original message is acknowledged after processing.
Also, a <code>SqsHeaders.SQS_MESSAGE_ID_HEADER</code> must always be present.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>intercept</code> methods must not return null.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>afterProcessing</code> methods are executed after message is processed and the <code>ErrorHandler</code> is invoked, but before the message is acknowledged.</p>
</div>
</div>
<div class="sect2">
<h3 id="error-handling"><a class="anchor" href="#error-handling"></a><a class="link" href="#error-handling">8.5. Error Handling</a></h3>
<div class="paragraph">
<p>By default, messages that have an error thrown by the listener will not be acknowledged, and the message can be polled again after <code>visibility timeout</code> expires.</p>
</div>
<div class="paragraph">
<p>Alternatively, the framework offers the <code>ErrorHandler</code> and <code>AsyncErrorHandler</code> interfaces, which are invoked after a listener execution fails.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface ErrorHandler&lt;T&gt; {

    default void handle(Message&lt;T&gt; message, Throwable t) {
    }

    default void handle(Collection&lt;Message&lt;T&gt;&gt; messages, Throwable t) {
    }

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface AsyncErrorHandler&lt;T&gt; {

    default CompletableFuture&lt;Void&gt; handle(Message&lt;T&gt; message, Throwable t) {
        return CompletableFutures.failedFuture(t);
    }

    default CompletableFuture&lt;Void&gt; handle(Collection&lt;Message&lt;T&gt;&gt; messages, Throwable t) {
        return CompletableFutures.failedFuture(t);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the auto-configured factory, simply declare a <code>@Bean</code> and the error handler will be set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public ErrorHandler&lt;Object&gt; errorHandler() {
    return new ErrorHandler&lt;Object&gt;() {
        @Override
        public void handle(Message&lt;Object&gt; message, Throwable t) {
            // error handling logic
            // throw if the message should not be acknowledged
        }
    }}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, implementations can be set in the <code>MessageListenerContainerFactory</code> or directly in the <code>MessageListenerContainer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
public SqsMessageListenerContainerFactory&lt;Object&gt; defaultSqsListenerContainerFactory() {
    return SqsMessageListenerContainerFactory
        .builder()
        .sqsAsyncClientSupplier(BaseSqsIntegrationTest::createAsyncClient)
        .errorHandler(new ErrorHandler&lt;Object&gt;() {
            @Override
            public void handle(Message&lt;Object&gt; message, Throwable t) {
                // error handling logic
            }
        })
        .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the error handler execution succeeds, i.e. no error is thrown from the error handler, the message is considered to be recovered and is acknowledged according to the acknowledgement configuration.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If the message should not be acknowledged and the <code>ON_SUCCESS</code> acknowledgement mode is set, it&#8217;s important to propagate the error.
For simply executing an action in case of errors, an <code>interceptor</code> should be used instead, checking the presence of the <code>throwable</code> argument for detecting a failed execution.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="message-conversion-and-payload-deserialization"><a class="anchor" href="#message-conversion-and-payload-deserialization"></a><a class="link" href="#message-conversion-and-payload-deserialization">8.6. Message Conversion and Payload Deserialization</a></h3>
<div class="paragraph">
<p>Payloads are automatically deserialized from <code>JSON</code> for <code>@SqsListener</code> annotated methods using a <code>MappingJackson2MessageConverter</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using Spring Boot&#8217;s auto-configuration, if there&#8217;s a single <code>ObjectMapper</code> in Spring Context, such object mapper will be used for converting messages.
This includes the one provided by Spring Boot&#8217;s auto-configuration itself.
For configuring a different <code>ObjectMapper</code>, see <a href="#global-configuration-for-sqslisteners">Global Configuration for @SqsListeners</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For manually created <code>MessageListeners</code>, <code>MessageInterceptor</code> and <code>ErrorHandler</code> components, or more fine-grained conversion such as using <code>interfaces</code> or <code>inheritance</code> in listener methods, type mapping is required for payload deserialization.</p>
</div>
<div class="paragraph">
<p>By default, the framework looks for a <code>MessageHeader</code> named <code>Sqs_MA_JavaType</code> containing the fully qualified class name (<code>FQCN</code>) for which the payload should be deserialized to.
If such header is found, the message is automatically deserialized to the provided class.</p>
</div>
<div class="paragraph">
<p>Further configuration can be achieved by providing a configured <code>MessagingMessageConverter</code> instance in the <code>ContainerOptions</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If type mapping is setup or type information is added to the headers, payloads are deserialized right after the message is polled.
Otherwise, for <code>@SqsListener</code> annotated methods, payloads are deserialized right before the message is sent to the listener.
For providing custom <code>MessageConverter</code> instances to be used by <code>@SqsListener</code> methods, see <a href="#global-configuration-for-sqslisteners">Global Configuration for @SqsListeners</a>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="configuring-a-messagingmessageconverter"><a class="anchor" href="#configuring-a-messagingmessageconverter"></a><a class="link" href="#configuring-a-messagingmessageconverter">8.6.1. Configuring a MessagingMessageConverter</a></h4>
<div class="paragraph">
<p>The framework provides the <code>SqsMessagingMessageConverter</code>, which implements the <code>MessagingMessageConverter</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface MessagingMessageConverter&lt;S&gt; {

    Message&lt;?&gt; toMessagingMessage(S source);

    S fromMessagingMessage(Message&lt;?&gt; message);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default header-based type mapping can be configured to use a different header name by using the <code>setPayloadTypeHeader</code> method.</p>
</div>
<div class="paragraph">
<p>More complex mapping can be achieved by using the <code>setPayloadTypeMapper</code> method, which overrides the default header-based mapping.
This method receives a <code>Function&lt;Message&lt;?&gt;, Class&lt;?&gt;&gt; payloadTypeMapper</code> that will be applied to incoming messages.</p>
</div>
<div class="paragraph">
<p>The default <code>MappingJackson2MessageConverter</code> can be replaced by using the <code>setPayloadMessageConverter</code> method.</p>
</div>
<div class="paragraph">
<p>The framework also provides the <code>SqsHeaderMapper</code>, which implements the <code>HeaderMapper</code> interface and is invoked by the <code>SqsMessagingMessageConverter</code>.
To provide a different <code>HeaderMapper</code> implementation, use the <code>setHeaderMapper</code> method.</p>
</div>
<div class="paragraph">
<p>An example of such configuration follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// Create converter instance
SqsMessagingMessageConverter messageConverter = new SqsMessagingMessageConverter();

// Configure Type Header
messageConverter.setPayloadTypeHeader("myTypeHeader");

// Configure Header Mapper
SqsHeaderMapper headerMapper = new SqsHeaderMapper();
headerMapper.setAdditionalHeadersFunction(((sqsMessage, accessor) -&gt; {
    accessor.setHeader("myCustomHeader", "myValue");
    return accessor.toMessageHeaders();
}));
messageConverter.setHeaderMapper(headerMapper);

// Configure Payload Converter
MappingJackson2MessageConverter payloadConverter = new MappingJackson2MessageConverter();
payloadConverter.setPrettyPrint(true);
messageConverter.setPayloadMessageConverter(payloadConverter);

// Set MessageConverter to the factory or container
factory.configure(options -&gt; options.messageConverter(messageConverter));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="interfaces-and-subclasses-in-listener-methods"><a class="anchor" href="#interfaces-and-subclasses-in-listener-methods"></a><a class="link" href="#interfaces-and-subclasses-in-listener-methods">8.6.2. Interfaces and Subclasses in Listener Methods</a></h4>
<div class="paragraph">
<p>Interfaces and subclasses can be used in <code>@SqsListener</code> annotated methods by configuring a <code>type mapper</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">messageConverter.setPayloadTypeMapper(message -&gt; {
    String eventTypeHeader = message.getHeaders().get("myEventTypeHeader", String.class);
    return "eventTypeA".equals(eventTypeHeader)
        ? MyTypeA.class
        : MyTypeB.class;
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then, in the listener method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@SpringBootApplication
public class SqsApplication {

    public static void main(String[] args) {
        SpringApplication.run(SqsApplication.class, args);
    }

    // Retrieve the converted payload
    @SqsListener("myQueue")
    public void listen(MyInterface message) {
        System.out.println(message);
    }

    // Or retrieve a Message with the converted payload
    @SqsListener("myOtherQueue")
    public void listen(Message&lt;MyInterface&gt; message) {
        System.out.println(message);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="acknowledging-messages"><a class="anchor" href="#acknowledging-messages"></a><a class="link" href="#acknowledging-messages">8.7. Acknowledging Messages</a></h3>
<div class="paragraph">
<p>In <code>SQS</code> acknowledging a message is the same as deleting the message from the queue.
A number of <code>Acknowledgement</code> strategies are available and can be configured via <code>ContainerOptions</code>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of a possible configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
SqsMessageListenerContainerFactory&lt;Object&gt; defaultSqsListenerContainerFactory(SqsAsyncClient sqsAsyncClient) {
    return SqsMessageListenerContainerFactory
            .builder()
            .configure(options -&gt; options
                    .acknowledgementMode(AcknowledgementMode.ALWAYS)
                    .acknowledgementInterval(Duration.ofSeconds(3))
                    .acknowledgementThreshold(5)
                    .acknowledgementOrdering(AcknowledgementOrdering.ORDERED)
            )
            .sqsAsyncClient(sqsAsyncClient)
            .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each option is explained in the following sections.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All options are available for both <code>single message</code> and <code>batch</code> message listeners.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="acknowledgement-mode"><a class="anchor" href="#acknowledgement-mode"></a><a class="link" href="#acknowledgement-mode">8.7.1. Acknowledgement Mode</a></h4>
<div class="ulist">
<ul>
<li>
<p><code>ON_SUCCESS</code> - Acknowledges a message or batch of messages after successful processing.</p>
</li>
<li>
<p><code>ALWAYS</code> - Acknowledges a message or batch of messages after processing returns success or error.</p>
</li>
<li>
<p><code>MANUAL</code> - The framework won&#8217;t acknowledge messages automatically and <code>Acknowledgement</code> objects can be received in the listener method.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="acknowledgement-batching"><a class="anchor" href="#acknowledgement-batching"></a><a class="link" href="#acknowledgement-batching">8.7.2. Acknowledgement Batching</a></h4>
<div class="paragraph">
<p>The <code>acknowledgementInterval</code> and <code>acknowledgementThreshold</code> options enable acknowledgement batching.
Acknowledgements will be executed after either the amount of time specified in the <code>interval</code> or the number of messages to acknowledge reaches the <code>threshold</code>.</p>
</div>
<div class="paragraph">
<p>Setting <code>acknowledgementInterval</code> to <code>Duration.ZERO</code> will disable the periodic acknowledgement, which will be executed only when the number of messages to acknowledge reaches the specified <code>acknowledgementThreshold</code>.</p>
</div>
<div class="paragraph">
<p>Setting <code>acknowledgementThreshold</code> to <code>0</code> will disable acknowledging per number of messages, and messages will be acknowledged only on the specified <code>acknowldgementInterval</code></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When using acknowledgement batching messages stay inflight for SQS purposes until their respective batch is acknowledged. <code>MessageVisibility</code> should be taken into consideration when configuring this strategy.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="immediate-acknowledging"><a class="anchor" href="#immediate-acknowledging"></a><a class="link" href="#immediate-acknowledging">Immediate Acknowledging</a></h5>
<div class="paragraph">
<p>Setting both <code>acknowledgementInterval</code> and <code>acknowledgementThreshold</code> to <code>Duration.ZERO</code> and <code>0</code> respectively enables <code>Immediate Acknowledging</code>.</p>
</div>
<div class="paragraph">
<p>With this configuration, messages are acknowledged sequentially after being processed, and the message is only considered processed after the message is successfully acknowledged.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If an immediate acknowledging triggers an error, message processing is considered failed and will be retried after the specified <code>visibilityTimeout</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manual-acknowledgement"><a class="anchor" href="#manual-acknowledgement"></a><a class="link" href="#manual-acknowledgement">8.7.3. Manual Acknowledgement</a></h4>
<div class="paragraph">
<p>Manual acknowledgement can be used in conjunction with acknowledgement batching - the message will be queued for acknowledgement but won&#8217;t be executed until one of the above criteria is met.</p>
</div>
<div class="paragraph">
<p>It can also be used in conjunction with immediate acknowledgement.</p>
</div>
</div>
<div class="sect3">
<h4 id="acknowledgement-ordering"><a class="anchor" href="#acknowledgement-ordering"></a><a class="link" href="#acknowledgement-ordering">8.7.4. Acknowledgement Ordering</a></h4>
<div class="ulist">
<ul>
<li>
<p><code>PARALLEL</code> - Acknowledges the messages as soon as one of the above criterias is met - many acknowledgement calls can be made in parallel.</p>
</li>
<li>
<p><code>ORDERED</code> - One batch of acknowledgements will only be executed after the previous one is completed, ensuring <code>FIFO</code> ordering of acknowledgements.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="acknowledgement-defaults"><a class="anchor" href="#acknowledgement-defaults"></a><a class="link" href="#acknowledgement-defaults">8.7.5. Acknowledgement Defaults</a></h4>
<div class="paragraph">
<p>The defaults for acknowledging differ for <code>Standard</code> and <code>FIFO</code> SQS queues.</p>
</div>
<div class="sect4">
<h5 id="standard-sqs"><a class="anchor" href="#standard-sqs"></a><a class="link" href="#standard-sqs">Standard SQS</a></h5>
<div class="ulist">
<ul>
<li>
<p>Acknowledgement Interval: One second</p>
</li>
<li>
<p>Acknowledgement Threshold: Ten messages</p>
</li>
<li>
<p>Acknowledgement Ordering: <code>PARALLEL</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="fifo-sqs"><a class="anchor" href="#fifo-sqs"></a><a class="link" href="#fifo-sqs">FIFO SQS</a></h5>
<div class="ulist">
<ul>
<li>
<p>Acknowledgement Interval: Zero (Immediate)</p>
</li>
<li>
<p>Acknowledgement Threshold: Zero (Immediate)</p>
</li>
<li>
<p>Acknowledgement Ordering: <code>PARALLEL</code> if immediate acknowledgement, <code>ORDERED</code> if batching is enabled (one or both above defaults are overridden).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
PARALLEL is the default for FIFO because ordering is guaranteed for processing.
This assures no messages from a given <code>MessageGroup</code> will be polled until the previous batch is acknowledged.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="global-configuration-for-sqslisteners"><a class="anchor" href="#global-configuration-for-sqslisteners"></a><a class="link" href="#global-configuration-for-sqslisteners">8.8. Global Configuration for @SqsListeners</a></h3>
<div class="paragraph">
<p>A set of configurations can be set for all containers from <code>@SqsListener</code> by providing <code>SqsListenerCustomizer</code> beans.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@FunctionalInterface
public interface SqsListenerCustomizer {

    void configure(EndpointRegistrar registrar);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following attributes can be configured in the registrar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>setMessageHandlerMethodFactory</code> - provide a different factory to be used to create the <code>invocableHandlerMethod</code> instances that wrap the listener methods.</p>
</li>
<li>
<p><code>setListenerContainerRegistry</code> - provide a different <code>MessageListenerContainerRegistry</code> implementation to be used to register the <code>MessageListenerContainers</code></p>
</li>
<li>
<p><code>setMessageListenerContainerRegistryBeanName</code> - provide a different bean name to be used to retrieve the <code>MessageListenerContainerRegistry</code></p>
</li>
<li>
<p><code>setObjectMapper</code> - set the <code>ObjectMapper</code> instance that will be used to deserialize payloads in listener methods.
See <a href="#message-conversion-and-payload-deserialization">Message Conversion and Payload Deserialization</a> for more information on where this is used.</p>
</li>
<li>
<p><code>manageMessageConverters</code> - gives access to the list of message converters that will be used to convert messages.
By default, <code>StringMessageConverter</code>, <code>SimpleMessageConverter</code> and <code>MappingJackson2MessageConverter</code> are used.</p>
</li>
<li>
<p><code>manageArgumentResolvers</code> - gives access to the list of argument resolvers that will be used to resolve the listener method arguments.
The order of resolvers is important - <code>PayloadMethodArgumentResolver</code> should generally be last since it&#8217;s used as default.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A simple example would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean
SqsListenerCustomizer customizer(ObjectMapper objectMapper) {
    return registrar -&gt; registrar.setObjectMapper(objectMapper);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Many <code>SqsListenerCustomizer</code> beans can be registered in the context.
All instances will be looked up at application startup and iterated through.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="message-processing-throughput"><a class="anchor" href="#message-processing-throughput"></a><a class="link" href="#message-processing-throughput">8.9. Message Processing Throughput</a></h3>
<div class="paragraph">
<p>The following options are available for tuning the application&#8217;s throughput.
When a configuration is available both in the <code>ContainerOptions</code> and <code>@SqsListener</code> annotation, the annotation value takes precedence, if any.</p>
</div>
<div class="sect3">
<h4 id="containeroptions-and-sqslistener-properties"><a class="anchor" href="#containeroptions-and-sqslistener-properties"></a><a class="link" href="#containeroptions-and-sqslistener-properties">8.9.1. ContainerOptions and <code>@SqsListener</code> properties</a></h4>
<div class="sect4">
<h5 id="maxinflightmessagesperqueue"><a class="anchor" href="#maxinflightmessagesperqueue"></a><a class="link" href="#maxinflightmessagesperqueue">maxInflightMessagesPerQueue</a></h5>
<div class="paragraph">
<p>Can be set in either the <code>ContainerOptions</code> or the <code>@SqsListener</code> annotation.
Represents the maximum number of messages being processed by the container at a given time.
Defaults to 10.</p>
</div>
<div class="paragraph">
<p>This value is enforced per queue, meaning the number of inflight messages in a container can be up to (number of queues in container * maxInflightMessagesPerQueue).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using acknowledgement batching, a message is considered as no longer inflight when it&#8217;s delivered to the acknowledgement queue. In this case, the actual number of inflight messages on AWS SQS console can be higher than the configured value.
When using immediate acknowledgement, a message is considered as no longer inflight after it&#8217;s been acknowledged or throws an error.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="maxmessagesperpoll"><a class="anchor" href="#maxmessagesperpoll"></a><a class="link" href="#maxmessagesperpoll">maxMessagesPerPoll</a></h5>
<div class="paragraph">
<p>Set in <code>ContainerOptions</code>.
Represents the maximum number of messages returned by a single poll to a SQS queue, to a maximum of 10.
This value has to be less than or equal to <code>maxInflightMessagesPerQueue</code>.
Defaults to 10.</p>
</div>
<div class="paragraph">
<p>Note that even if the queue has more messages, a poll can return less messages than specified. See the AWS documentation for more information.</p>
</div>
</div>
<div class="sect4">
<h5 id="polltimeout"><a class="anchor" href="#polltimeout"></a><a class="link" href="#polltimeout">pollTimeout</a></h5>
<div class="paragraph">
<p>Can be set in either the <code>ContainerOptions</code> or the <code>@SqsListener</code> annotation.
Represents the maximum duration of a poll.
Higher values represent <code>long polls</code> and increase the probability of receiving full batches of messages.
Defaults to 10 seconds.</p>
</div>
</div>
<div class="sect4">
<h5 id="permitacquiretimeout"><a class="anchor" href="#permitacquiretimeout"></a><a class="link" href="#permitacquiretimeout">permitAcquireTimeout</a></h5>
<div class="paragraph">
<p>Set in <code>ContainerOptions</code>.
Represents the maximum amount of time the container will wait for <code>maxMessagesPerPoll</code> permits to be available before trying to acquire a partial batch.
This wait is applied per queue and one queue has no interference in another in this regard.
Defaults to 10 seconds.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="default-polling-behavior"><a class="anchor" href="#default-polling-behavior"></a><a class="link" href="#default-polling-behavior">8.9.2. Default Polling Behavior</a></h4>
<div class="paragraph">
<p>By default, the framework starts all queues in <code>low throughput mode</code>, where it will perform one poll for messages at a time.
When a poll returns at least one message, the queue enters a <code>high throughput mode</code> where it will try to fulfill <code>maxInflightMessagesPerQueue</code> messages by making (maxInflightMessagesPerQueue / maxMessagesPerPoll) parallel polls to the queue.
Any poll that returns no messages will trigger a <code>low throughput mode</code> again, until at least one message is returned, triggering <code>high throughput mode</code> again, and so forth.</p>
</div>
<div class="paragraph">
<p>After <code>permitAcquireTimeout</code>, if <code>maxMessagesPerPoll</code> permits are not available, it&#8217;ll poll for the difference, i.e. as many messages as have been processed so far, if any.</p>
</div>
<div class="paragraph">
<p>E.g. Let&#8217;s consider a scenario where the container is configured for: <code>maxInflightMessagesPerQueue</code> = 20, <code>maxMessagesPerPoll</code> = 10, <code>permitAcquireTimeout</code> = 5 seconds, and a <code>pollTimeout</code> = 10 seconds.</p>
</div>
<div class="paragraph">
<p>The container starts in <code>low throughput mode</code>, meaning it&#8217;ll attempt a single poll for 10 messages.
If any messages are returned, it&#8217;ll switch to <code>high throughput mode</code>, and will make up to 2 simultaneous polls for 10 messages each.
If all 20 messages are retrieved, it&#8217;ll not attempt any more polls until messages are processed.
If after the 5 seconds for <code>permitAcquireTimeout</code> 6 messages have been processed, the framework will poll for the 6 messages.
If the queue is depleted and a poll returns no messages, it&#8217;ll enter <code>low throughput</code> mode again and perform only one poll at a time.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-backpressuremode"><a class="anchor" href="#configuring-backpressuremode"></a><a class="link" href="#configuring-backpressuremode">8.9.3. Configuring BackPressureMode</a></h4>
<div class="paragraph">
<p>The following <code>BackPressureMode</code> values can be set in <code>ContainerOptions</code> to configure polling behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AUTO</code> - The default mode, as described in the previous section.</p>
</li>
<li>
<p><code>ALWAYS_POLL_MAX_MESSAGES</code> - Disables partial batch polling, i.e. if the container is configured for 10 messages per poll, it&#8217;ll wait for 10 messages to be processed before attempting to poll for the next 10 messages.
Useful for optimizing for fewer polls at the expense of throughput.</p>
</li>
<li>
<p><code>FIXED_HIGH_THROUGHPUT</code> - Disables <code>low throughput mode</code>, while still attempting partial batch polling as described in the previous section.
Useful for really high throughput scenarios where the risk of making parallel polls to an idle queue is preferable to an eventual switch to <code>low throughput mode</code> .</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>AUTO</code> setting should be balanced for most use cases, including high throughput ones.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="blocking-and-non-blocking-async-components"><a class="anchor" href="#blocking-and-non-blocking-async-components"></a><a class="link" href="#blocking-and-non-blocking-async-components">8.10. Blocking and Non-Blocking (Async) Components</a></h3>
<div class="paragraph">
<p>The SQS integration leverages the <code>CompletableFuture</code>-based async capabilities of <code>AWS SDK 2.0</code> to deliver a fully non-blocking infrastructure.
All processing involved in polling for messages, changing message visibilities and acknowledging messages is done in an async, non-blocking fashion. This allows a higher overall throughput for the application.</p>
</div>
<div class="paragraph">
<p>When a <code>MessageListener</code>, <code>MessageInterceptor</code>, and <code>ErrorHandler</code> implementation is set to a <code>MesssageListenerContainer</code> or <code>MesssageListenerContainerFactory</code> these are adapted by the framework. This way, blocking and non-blocking components can be used in conjunction with each other.</p>
</div>
<div class="paragraph">
<p>Listener methods annotated with <code>@SqsListener</code> can either return a simple value, e.g. <code>void</code>, or a <code>CompletableFuture&lt;Void&gt;</code>.
The listener method will then be wrapped in either a <code>MessagingMessageListenerAdapter</code> or a <code>AsyncMessagingMessageListenerAdapter</code> respectively.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In order to achieve higher throughput, it&#8217;s encouraged that, at least for simpler logic in message listeners, <code>interceptors</code> and <code>error handlers</code>, the async variants are used.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="threading-and-blocking-components"><a class="anchor" href="#threading-and-blocking-components"></a><a class="link" href="#threading-and-blocking-components">8.10.1. Threading and Blocking Components</a></h4>
<div class="paragraph">
<p>Message processing always starts in a framework thread from the default or provided <code>TaskExecutor</code>.</p>
</div>
<div class="paragraph">
<p>If an async component is invoked and the execution returns to the framework on a different thread, such thread will be used until a <code>blocking</code> component is found, when the execution switches back to a <code>TaskExecutor</code> thread to avoid blocking i.e. <code>SqsAsyncClient</code> or <code>HttpClient</code> threads.</p>
</div>
<div class="paragraph">
<p>If by the time the execution reaches a <code>blocking</code> component it&#8217;s already on a framework thread, it remains in the same thread to avoid excessive thread allocation and hopping.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When using <code>async</code> methods it&#8217;s critical not to block the incoming thread, which might be very detrimental to overall performance.
If thread-blocking logic has to be used, the blocking logic should be executed on another thread, e.g. using <code>CompletableFuture.supplyAsync(() &#8594; myLogic(), myExecutor)</code>.
Otherwise, a <code>sync</code> interface should be used.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="providing-a-taskexecutor"><a class="anchor" href="#providing-a-taskexecutor"></a><a class="link" href="#providing-a-taskexecutor">8.10.2. Providing a TaskExecutor</a></h4>
<div class="paragraph">
<p>The default <code>TaskExecutor</code> is a <code>ThreadPoolTaskExecutor</code>, and a different <code>componentTaskExecutor</code> can be set in the <code>ContainerOptions</code>.</p>
</div>
<div class="paragraph">
<p>When providing a custom executor, it&#8217;s important that it&#8217;s configured to support all threads that will be created, which should be (maxInflightMessagesPerQueue * total number of queues).
When set as a <code>MessageListenerContainerFactory</code> options, it&#8217;s important to consider all the containers it will be applied to.
Also, to avoid excessive thread hopping, a <code>MessageExecutionThreadFactory</code> should be set to the executor.</p>
</div>
<div class="paragraph">
<p>If setting the <code>ThreadFactory</code> is not possible, it&#8217;s advisable to allow for extra threads in the thread pool to account for the time between a new thread is requested and the previous thread is released.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="iam-permissions-5"><a class="anchor" href="#iam-permissions-5"></a><a class="link" href="#iam-permissions-5">8.11. IAM Permissions</a></h3>
<div class="paragraph">
<p>Following IAM permissions are required by Spring Cloud AWS SQS:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send message to Queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqs:SendMessage</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Receive message from queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqs:ReceiveMessage</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete message from queue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqs:DeleteMessage</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">To use sqsListener with SimpleMessageListenerContainerFactory you will need to add as well</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqs:GetQueueAttributes</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">To use SqsListener with Sqs name instead of ARN you will need</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sqs:GetQueueUrl</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Sample IAM policy granting access to SQS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "sqs:DeleteMessage",
                "sqs:ReceiveMessage",
                "sqs:SendMessage",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl"
            ],
            "Resource": "yourARN"
        }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-aws-secrets-manager"><a class="anchor" href="#spring-cloud-aws-secrets-manager"></a><a class="link" href="#spring-cloud-aws-secrets-manager">9. Secrets Manager Integration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://aws.amazon.com/secrets-manager/">Secrets Manager</a> helps to protect secrets needed to access your applications, services, and IT resources. The service enables you to easily rotate, manage, and retrieve database credentials, API keys, and other secrets throughout their lifecycle.</p>
</div>
<div class="paragraph">
<p>Spring Cloud AWS adds support for loading configuration properties from Secrets Manager through Spring Boot <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config-files-importing">config import feature</a>.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Cloud AWS BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-aws-starter-secrets-manager&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="loading-external-configuration"><a class="anchor" href="#loading-external-configuration"></a><a class="link" href="#loading-external-configuration">9.1. Loading External Configuration</a></h3>
<div class="paragraph">
<p>To fetch secrets from Secrets Manager and add them to Spring&#8217;s environment properties, add <code>spring.config.import</code> property to <code>application.properties</code>:</p>
</div>
<div class="paragraph">
<p>For example, assuming that the secret name in Secrets Manager is <code>/secrets/database-secrets</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=aws-secretsmanager:/secrets/database-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a secret with given name does not exist in Secrets Manager, application will fail to start. If secret value is not required for the application, and it should continue to startup even when secret is missing, add <code>optional</code> before prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=optional:aws-secretsmanager:/secrets/database-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>To load multiple secrets, separate their names with <code>;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=aws-secretsmanager:/secrets/database-secrets;/secrets/webclient-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>If some secrets are required, and other ones are optional, list them as separate entries in <code>spring.config.import</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import[0]=optional:aws-secretsmanager=/secrets/required-secret
spring.config.import[1]=aws-secretsmanager=/secrets/optional-secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fetched secrets can be referenced with <code>@Value</code>, bound to <code>@ConfigurationProperties</code> classes, or referenced in <code>application.properties</code> file.</p>
</div>
<div class="sect3">
<h4 id="using-key-value-json-secrets"><a class="anchor" href="#using-key-value-json-secrets"></a><a class="link" href="#using-key-value-json-secrets">9.1.1. Using Key-Value (JSON) Secrets</a></h4>
<div class="paragraph">
<p>Secrets resolved with <code>spring.config.import</code> can be also referenced in <code>application.properties</code>.
When a content of <code>SecretString</code> in a JSON, all top level JSON keys are added as properties to Spring Environment.</p>
</div>
<div class="paragraph">
<p>For example, with a file <code>mycreds.json</code> containing following JSON structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
      "username": "saanvi",
      "password": "EXAMPLE-PASSWORD"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secret is created with a command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ aws secretsmanager create-secret --name /secrets/database-secrets --secret-string file://mycreds.json</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>spring.config.import</code> entry is added to <code>application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=aws-secretsmanager:/secrets/database-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secret values can be referenced by JSON key names:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value("${username}"
private String username;

@Value("${password}"
private String password;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-plain-text-secrets"><a class="anchor" href="#using-plain-text-secrets"></a><a class="link" href="#using-plain-text-secrets">9.1.2. Using plain text secrets</a></h4>
<div class="paragraph">
<p>If a <code>SecretString</code> is a plain text, use secret name to retrieve its value.
For example, we will JDBC saved as plain text secret type with name <code>/secrets/my-certificate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ aws secretsmanager create-secret --name /secrets/prod/jdbc-url --secret-string jdbc:url</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>spring.config.import</code> entry is added to <code>application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=aws-secretsmanager:/secrets/prod/jdbc-url</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secret value can be retrieved by referencing secret name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.datasource.url=${jdbc-url}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-secretsmanagerclient"><a class="anchor" href="#using-secretsmanagerclient"></a><a class="link" href="#using-secretsmanagerclient">9.2. Using SecretsManagerClient</a></h3>
<div class="paragraph">
<p>The starter automatically configures and registers a <code>SecretsManagerClient</code> bean in the Spring application context. The <code>SecretsManagerClient</code> bean can be used to create or retrieve secrets imperatively.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import org.springframework.stereotype.Component;
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClient;
import software.amazon.awssdk.services.secretsmanager.model.CreateSecretRequest;
...
@Autowired
private SecretsManagerClient secretsManagerClient;
...
secretsManagerClient.createSecret(CreateSecretRequest.builder().name(name).secretString(secret).build());</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="customizing-secretsmanagerclient"><a class="anchor" href="#customizing-secretsmanagerclient"></a><a class="link" href="#customizing-secretsmanagerclient">9.3. Customizing SecretsManagerClient</a></h3>
<div class="paragraph">
<p>To use custom <code>SecretsManagerClient</code> in <code>spring.config.import</code>, provide an implementation of <code>BootstrapRegistryInitializer</code>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.app;

import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;
import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClient;

import org.springframework.boot.BootstrapRegistry;
import org.springframework.boot.BootstrapRegistryInitializer;

public class SecretsManagerBootstrapConfiguration implements BootstrapRegistryInitializer {

    @Override
    public void initialize(BootstrapRegistry registry) {
        registry.register(SecretsManagerClient.class, context -&gt; {
            AwsCredentialsProvider awsCredentialsProvider = StaticCredentialsProvider.create(AwsBasicCredentials.create("yourAccessKey", "yourSecretKey"));
            return SecretsManagerClient.builder().credentialsProvider(awsCredentialsProvider).region(Region.EU_WEST_2).build();
        });
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this class must be listed under <code>org.springframework.boot.BootstrapRegistryInitializer</code> key in <code>META-INF/spring.factories</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">org.springframework.boot.BootstrapRegistryInitializer=com.app.SecretsManagerBootstrapConfiguration</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use autoconfigured <code>SecretsManagerClient</code> but change underlying SDKClient or ClientOverrideConfiguration you will need to register bean of type <code>AwsClientConfigurerSecretsManager</code>:
Autoconfiguration will configure <code>SecretsManagerClient</code> Bean with provided values after that, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.app;

import io.awspring.cloud.autoconfigure.config.secretsmanager.AwsSecretsManagerClientCustomizer;
import java.time.Duration;
import org.springframework.boot.BootstrapRegistry;
import org.springframework.boot.BootstrapRegistryInitializer;
import software.amazon.awssdk.core.client.config.ClientOverrideConfiguration;
import software.amazon.awssdk.http.SdkHttpClient;
import software.amazon.awssdk.http.apache.ApacheHttpClient;
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClientBuilder;

class SecretsManagerBootstrapConfiguration implements BootstrapRegistryInitializer {

    @Override
    public void initialize(BootstrapRegistry registry) {
        registry.register(AwsSecretsManagerClientCustomizer.class,
            context -&gt; new AwsSecretsManagerClientCustomizer() {

                @Override
                public ClientOverrideConfiguration overrideConfiguration() {
                    return ClientOverrideConfiguration.builder().apiCallTimeout(Duration.ofMillis(500))
                            .build();
                }

                @Override
                public SdkHttpClient httpClient() {
                    return ApacheHttpClient.builder().connectionTimeout(Duration.ofMillis(1000)).build();
                }
            });
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-5"><a class="anchor" href="#configuration-5"></a><a class="link" href="#configuration-5">9.4. Configuration</a></h3>
<div class="paragraph">
<p>The Spring Boot Starter for Secrets Manager provides the following configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 42.8571%;">
<col style="width: 14.2857%;">
<col style="width: 14.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.secretsmanager.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the Secrets Manager integration.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.secretsmanager.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures endpoint used by <code>SecretsManagerClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.secretsmanager.region</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures region used by <code>SecretsManagerClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="iam-permissions-6"><a class="anchor" href="#iam-permissions-6"></a><a class="link" href="#iam-permissions-6">9.5. IAM Permissions</a></h3>
<div class="paragraph">
<p>Following IAM permissions are required by Spring Cloud AWS:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get secret value:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>secretsmanager:GetSecretValue</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Sample IAM policy granting access to Secrets Manager:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "secretsmanager:GetSecretValue",
            "Resource": "yourArn"
        }
    ]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-cloud-aws-parameter-store"><a class="anchor" href="#spring-cloud-aws-parameter-store"></a><a class="link" href="#spring-cloud-aws-parameter-store">10. Parameter Store Integration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Cloud AWS adds support for loading configuration properties from Parameter Store through Spring Boot <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config-files-importing">config import feature</a>.</p>
</div>
<div class="paragraph">
<p>Maven coordinates, using <a href="#bill-of-materials">Spring Cloud AWS BOM</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
    &lt;groupId&gt;io.awspring.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-aws-parameter-store&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="loading-external-configuration-2"><a class="anchor" href="#loading-external-configuration-2"></a><a class="link" href="#loading-external-configuration-2">10.1. Loading External Configuration</a></h3>
<div class="paragraph">
<p>To fetch parameters from Parameter Store and add them to Spring&#8217;s environment properties, add <code>spring.config.import</code> property to <code>application.properties</code>:</p>
</div>
<div class="paragraph">
<p>For example, assuming that the parameters in Parameter Store are stored under path <code>/config/spring</code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Parameter Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/config/spring/message</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Welcome</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/config/spring/httpUrl</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="https://external-service:3030/" class="bare">external-service:3030/</a></code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Once <code>spring.config.import</code> statement is added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=aws-parameterstore:/config/spring</code></pre>
</div>
</div>
<div class="paragraph">
<p>Two parameters are added to environment: <code>message</code> and <code>httpUrl</code>.</p>
</div>
<div class="paragraph">
<p>If a given path in Parameter Store does not exist, application will fail to start. If parameters retrieved from Parameter Store are not required for the application, and it should continue to startup even when the path is missing, add <code>optional</code> before prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=optional:aws-parameterstore:/config/spring</code></pre>
</div>
</div>
<div class="paragraph">
<p>To load parameters from multiple paths, separate their names with <code>;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import=aws-parameterstore:/config/spring;/config/app</code></pre>
</div>
</div>
<div class="paragraph">
<p>If some parameters are required, and other ones are optional, list them as separate entries in <code>spring.config.import</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">spring.config.import[0]=optional:aws-parameterstore=/config/spring
spring.config.import[1]=aws-parameterstore=/config/optional-params/</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-ssmclient"><a class="anchor" href="#using-ssmclient"></a><a class="link" href="#using-ssmclient">10.2. Using SsmClient</a></h3>
<div class="paragraph">
<p>The starter automatically configures and registers a <code>SsmClient</code> bean in the Spring application context. The <code>SsmClient</code> bean can be used to create or retrieve parameters from Parameter Store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import org.springframework.stereotype.Component;
import software.amazon.awssdk.services.ssm.SsmClient;
...
@Autowired
private SsmClient ssmClient;
...
ssmClient.getParametersByPath(request -&gt; request.path("/config/spring/")).parameters();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="customizing-ssmclient"><a class="anchor" href="#customizing-ssmclient"></a><a class="link" href="#customizing-ssmclient">10.3. Customizing SsmClient</a></h3>
<div class="paragraph">
<p>To use custom <code>SsmClient</code> in <code>spring.config.import</code>, provide an implementation of <code>BootstrapRegistryInitializer</code>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.app;

import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;
import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.ssm.SsmClient;

import org.springframework.boot.BootstrapRegistry;
import org.springframework.boot.BootstrapRegistryInitializer;

class ParameterStoreBootstrapConfiguration implements BootstrapRegistryInitializer {

    @Override
    public void initialize(BootstrapRegistry registry) {
        registry.register(SsmClient.class, context -&gt; {
            AwsCredentialsProvider awsCredentialsProvider = StaticCredentialsProvider.create(AwsBasicCredentials.create("yourAccessKey", "yourSecretKey"));
            return SsmClient.builder().credentialsProvider(awsCredentialsProvider).region(Region.EU_WEST_2).build();
        });
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this class must be listed under <code>org.springframework.boot.BootstrapRegistryInitializer</code> key in <code>META-INF/spring.factories</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="properties" class="language-properties hljs">org.springframework.boot.BootstrapRegistryInitializer=com.app.ParameterStoreBootstrapConfiguration</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use autoconfigured <code>SsmClient</code> but change underlying SDKClient or ClientOverrideConfiguration you will need to register bean of type <code>AwsClientConfigurerParameterStore</code>:
Autoconfiguration will configure <code>SsmClient</code> Bean with provided values after that, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.app;

import io.awspring.cloud.autoconfigure.config.parameterstore.AwsParameterStoreClientCustomizer;
import java.time.Duration;
import org.springframework.boot.BootstrapRegistry;
import org.springframework.boot.BootstrapRegistryInitializer;
import software.amazon.awssdk.core.client.config.ClientOverrideConfiguration;
import software.amazon.awssdk.http.SdkHttpClient;
import software.amazon.awssdk.http.apache.ApacheHttpClient;
import software.amazon.awssdk.services.ssm.SsmClientBuilder;

class ParameterStoreBootstrapConfiguration implements BootstrapRegistryInitializer {

    @Override
    public void initialize(BootstrapRegistry registry) {
        registry.register(AwsParameterStoreClientCustomizer.class,
            context -&gt; new AwsParameterStoreClientCustomizer() {

                @Override
                public ClientOverrideConfiguration overrideConfiguration() {
                    return ClientOverrideConfiguration.builder().apiCallTimeout(Duration.ofMillis(500))
                            .build();
                }

                @Override
                public SdkHttpClient httpClient() {
                    return ApacheHttpClient.builder().connectionTimeout(Duration.ofMillis(1000)).build();
                }
            });
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuration-6"><a class="anchor" href="#configuration-6"></a><a class="link" href="#configuration-6">10.4. Configuration</a></h3>
<div class="paragraph">
<p>The Spring Boot Starter for Parameter Store provides the following configuration options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 44.4444%;">
<col style="width: 33.3333%;">
<col style="width: 11.1111%;">
<col style="width: 11.1112%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.parameterstore.enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the Parameter Store integration.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.parameterstore.endpoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures endpoint used by <code>SsmClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spring.cloud.aws.parameterstore.region</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configures region used by <code>SsmClient</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="iam-permissions-7"><a class="anchor" href="#iam-permissions-7"></a><a class="link" href="#iam-permissions-7">10.5. IAM Permissions</a></h3>
<div class="paragraph">
<p>Following IAM permissions are required by Spring Cloud AWS:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get parameter from specific path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ssm:GetParametersByPath</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Sample IAM policy granting access to Parameter Store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "ssm:GetParametersByPath",
            "Resource": "yourArn"
        }
    ]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-properties"><a class="anchor" href="#configuration-properties"></a><a class="link" href="#configuration-properties">11. Configuration properties</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To see the list of all Spring Cloud AWS related configuration properties please check <a href="appendix.html">the Appendix page</a>.</p>
</div>
</div>
</div>
</div>
<link rel="stylesheet" href="js/highlight/styles/github.min.css">
<script src="js/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
</body>
</html>